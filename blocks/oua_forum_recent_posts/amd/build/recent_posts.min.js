define(["jquery","core/ajax","core/log","core/str","core/templates","core/notification","core/event","block_oua_forum_recent_posts/validator","block_oua_forum_recent_posts/jquery.blockUI"],function(a,b,c,d,e,f,g,h,i){var j,k=function(c){j=a("div.disucssion-list-head").data(),a("div.discussionloading").show(),a(".discussion-list-body").on("click","div.wrapper a",function(a){a.stopPropagation(),a.cancelBubble=!0}),b.call([{methodname:"block_oua_forum_get_discussions",args:{forumid:j.forumid,page:j.page,perpage:j.perpage},done:function(a){m(a.discussions,c)},fail:l}])},l=function(b){a("div.discussionloading").hide(),a("div.block_oua_forum_recent_posts a.showmore").hide(),d.get_strings([{key:"error"},{key:"loggedout",component:"block_oua_forum_recent_posts"},{key:"reload"},{key:"cancel"}]).done(function(a){if("undefined"!=typeof b.errorcode)switch(b.errorcode){case"servicenotavailable":f.confirm(a[0],a[1],a[2],a[3],function(){window.location.reload(!0)});break;default:f.exception(b)}}).fail(function(a){f.exception(b+" "+a)})},m=function(b,c){var d=e.render("block_oua_forum_recent_posts/discussions",{discussions:b});d.done(function(d,e){a("div.discussion-list-body").append(d);var f=a("div.discussion-recent");g.notifyFilterContentUpdated(f),j.page++,b.length<j.perpage?a("div.block_oua_forum_recent_posts a.showmore").hide():a("div.block_oua_forum_recent_posts a.showmore").show(),"function"==typeof c&&c(b)})},n=function(a){p(),k(function(b){q(a,b)})},o=function(c,d){b.call([{methodname:"block_oua_forum_get_discussion_by_id",args:{discussionid:c},done:function(b){var f=a("div.block_oua_forum_recent_posts"),g=a("#reply-post");g.collapse("hide"),g.appendTo(f);var h=e.render("block_oua_forum_recent_posts/discussions",{discussions:b.discussion,expanded:!0,newpostconfirm:!0});h.done(function(a,b){e.replaceNode('div.discussion-topic[data-discussionid="'+c+'"]',a,b)});var i=a('div.discussion-post[data-postid="'+d+'"]'),j=a("div.discussion-reply.alert-success").prependTo(i).show(),k=j.offset().top-200;a("html, body").animate({scrollTop:k},250),setTimeout(function(){a("div.discussion-reply.alert-success").slideUp(400,function(){a(this).prependTo(f)})},3e3)},fail:l}])},p=function(){j=a("div.disucssion-list-head").data("page",0);var b=a("div.block_oua_forum_recent_posts"),c=a("#confirm_delete_post_dialog");c.modal("hide"),c.appendTo(b);var d=a("#reply-post");d.collapse("hide"),d.appendTo(b),a("div.discussion-list-body").html("")},q=function(b,c){var d=!1;a.each(c,function(a,c){c.discussion==b&&(d=!0)}),d||0===c.length?(a('div.discussion-topic[data-discussionid="'+b+'"] .collapse').collapse("show"),u()):k(function(a){q(b,a)})},r=function(a,b,c,d){localStorage.setItem("forum_post_temp_save_subject_"+a+"_"+b,c),localStorage.setItem("forum_post_temp_save_message_"+a+"_"+b,d)},s=function(b){a("#"+b+"editable").html(""),a("#"+b).val("")},t=function(a,b){localStorage.removeItem("forum_post_temp_save_subject_"+a+"_"+b),localStorage.removeItem("forum_post_temp_save_message_"+a+"_"+b)},u=function(){a("div.discussionloading").hide()};a("#new-post").on("show.bs.collapse",function(b){var c=a(b.relatedTarget),d=c.data("forumid"),e=a(this).parents("form");"undefined"!==localStorage&&(e.find("input[name='subject']").val(localStorage["forum_post_temp_save_subject_new_"+d]),e.find("textarea[name='message']").val(localStorage["forum_post_temp_save_message_new_"+d])),a("div.block_oua_forum_recent_posts .alert").hide()}).on("click",".cancel",function(b){var c=a(this).parents("form"),d=c.data("forumid");c.find("input[name='subject']").val(""),c.find("textarea[name='message']").val(""),s("new-post-edit-message"),t("new",d),a(this).parents("form").validator("reset")}).on("click",".submit",function(b){a(this).parents("form").submit()}).find("form").validator().on("submit",function(c){var d=a(this),e=d.find("input[name='subject']"),f=d.find("textarea[name='message']"),g=d.find("input[name='inlineattachmentsid']"),h={forumid:j.forumid,subject:e.val(),message:f.val(),options:[{name:"inlineattachmentsid",value:g.val()}]};"undefined"!==localStorage&&r("new",h.forumid,h.subject,h.message),c.isDefaultPrevented()===!1&&b.call([{methodname:"block_oua_forum_add_discussion",args:h,done:function(b){e.val(""),f.val(""),s("new-post-edit-message"),a("#new-post").collapse("hide"),0===b.warnings.length?("undefined"!==localStorage&&t("new",h.forumid),a("div.discussion-posted.alert-success").show(),n(b.discussionid)):a("div.discussion-posted.alert-warning").show()},fail:l}]),c.preventDefault()}),a("#reply-post").on("show.bs.collapse",function(b){var c=a(this).parents("form"),d=c.data("postid");"undefined"!==localStorage&&c.find("textarea[name='message']").val(localStorage["forum_post_temp_save_message_reply_"+d]),a("div.block_oua_forum_recent_posts .alert").hide()}).on("click",".cancel",function(b){var c=a(this).parents("form"),d=c.data("postid");t("reply",d),c.find("input[name='subject']").val(""),c.find("textarea[name='message']").val(""),s("reply-post-edit-message"),a(this).parents("form").validator("reset")}).on("click",".submit",function(b){a(this).parents("form").submit()}).find("form").validator().on("submit",function(c){var d=a(this),e=d.parents(".discussion-post").data("postid"),f=d.find("input[name='subject']"),g=d.find("textarea[name='message']"),h=d.find("input[name='inlineattachmentsid']"),i={postid:e,subject:f.val(),message:g.val(),options:[{name:"inlineattachmentsid",value:h.val()}]};"undefined"!==localStorage&&r("reply",i.postid,i.subject,i.message),c.isDefaultPrevented()===!1&&b.call([{methodname:"block_oua_forum_add_discussion_post",args:i,done:function(b){f.val(""),g.val(""),s("reply-post-edit-message"),a("#reply-post").collapse("hide"),0===b.warnings.length?("undefined"!==localStorage&&t("reply",i.postid),o(b.discussionid,b.postid)):a("div.discussion-reply.alert-warning").show()},fail:l}]),c.preventDefault()});var v=function(c){a("div.block_oua_forum_recent_posts .alert").hide(),b.call([{methodname:"block_oua_forum_delete_discussion_post",args:{postid:c},done:function(b){a("div.discussion-deleted.alert-success").show(),p(),k(u)},fail:l}])},w=function(b){b.preventDefault();var c=a(this).parents(".discussion-post"),d=a("#confirm_delete_post_dialog");d.parents(".discussion-post").removeClass("modal-delete-on"),d.appendTo(c),c.addClass("modal-delete-on");var e=c.data("postid");d.modal({backdrop:!0}).on("hide.bs.modal",function(b){a(this).parents(".discussion-post").removeClass("modal-delete-on")}),a(".confirm-delete",d).data("postid",e),a(".modal-backdrop.in").appendTo(c),a("body").removeClass("modal-open")},x=function(b){b.preventDefault();var c=a(this).parents(".discussion-post"),d=a("#reply-post"),e=c.parents(".discussion-topic").find(".panel-title .subject").text();d.find("input[name='subject']").val("Re: "+e).attr("readonly",!0),d.appendTo(c),d.collapse("show")},y=function(b){var c=a(this).data("postid");a("#confirm_delete_post_dialog").modal("hide"),v(c)},z=function(a){return a.preventDefault(),k(u),!1};return a("div.block_oua_forum_recent_posts").on("click","a.showmore",z).on("click",".deletepost a",w).on("click",".discussionreply a",x).on("click",".confirm-delete",y),{initialise:function(){k(u)}}});