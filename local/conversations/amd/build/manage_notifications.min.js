define(["jquery","core/ajax","core/log","core/notification","core/templates","core/config","core/str","local_conversations/jquery.blockUI","block_oua_connections/request_connect"],function(a,b,c,d,e,f,g,h,i){var j,k="<span class='glyphicon glyphicon-refresh glyphicon-refresh-animate spinning'></span>",l=function(a){g.get_strings([{key:"error"},{key:"loggedout",component:"local_conversations"},{key:"reload"},{key:"cancel"}]).done(function(b){if("undefined"!=typeof a.errorcode)switch(a.errorcode){case"servicenotavailable":d.confirm(b[0],b[1],b[2],b[3],function(){window.location.reload(!0)});break;default:d.exception(a)}}).fail(function(b){d.exception(a+" "+b)})},m={methodname:"local_conversations_get_all_notifications",args:{},done:function(a){e.render("local_conversations/notification_list",a.notifications).done(function(a){s(),e.replaceNode("#notifications",a,"")})},fail:l},n={methodname:"local_conversations_get_cached_header_previews",args:{},done:function(b){e.render("local_conversations/partials_notification_alert",b.notification_preview_cache).done(function(b){s();var c=a(b);a("header .notification-count .dropdown-menu > ul").replaceWith(c.find(".dropdown-menu > ul")),a("header .notification-count .total-count.badge").replaceWith(c.find(".total-count.badge"))}),e.render("local_conversations/partials_message_alert",b.conversation_preview_cache).done(function(b){s();var c=a(b);a("header .message-count .dropdown-menu > ul").replaceWith(c.find(".dropdown-menu > ul")),a("header .message-count .total-count.badge").replaceWith(c.find(".total-count.badge"))})},fail:l},o=function(c){r(a("#allnotifications .notifications-list")),b.call([{methodname:"local_conversations_delete_messages_by_id",args:{messageids:c},fail:l},m,n])},p=function(c){b.call([{methodname:"local_conversations_mark_messages_read_by_id",args:{messageids:c},done:function(){a("#notifications .panel.unread").filter(function(){return-1!=c.indexOf(a(this).data("messageid"))}).removeClass("unread"),s()},fail:l},n])};a("#allnotifications").on("click",".notification-delete",function(){var b=a(this).data("messageid"),c=a("#confirm_delete_notification_dialog");c.modal({backdrop:!0}),a(".confirm-delete-one",c).data("messageid",[b])}).on("click",".confirm-delete-one",function(b){var c=a(this).data("messageid");o(c)}).on("click","a.delete-all-notification",function(b){b.preventDefault();var c=a("#confirm_delete_all_notification_dialog"),d=a("#notifications .panel").not("[data-isconnectionrequest=1]").map(function(){return a(this).data("messageid")}).toArray();0!==d.length&&(a(".confirm-delete-all",c).data("messageids",d),c.modal({backdrop:!0}))}).on("click",".confirm-delete-all",function(b){var c=a(this).data("messageids");o(c)}).on("click","a.mark-all-as-read",function(b){b.preventDefault();var c=a("#confirm_markallnotificationsasread_dialog"),d=a("#notifications .panel.unread").map(function(){return a(this).data("messageid")}).toArray();0!==d.length&&(a(".confirm-markallnotificationsasread",c).data("messageids",d),c.modal({backdrop:!0}))}).on("click",".confirm-markallnotificationsasread",function(b){r(a("#allnotifications .notifications-list"));var c=a(this).data("messageids");p(c)}),a("#allnotifications, header .notification-counter, #profile-block").on("click",".connectaccept, .connectignore",function(b){b.preventDefault(),b.stopPropagation();var c=a(this).data("userid"),d=a(this).data("messageid"),e=a(this);r(0!==a(this).parents(".notificationpopup").length?a(this).closest("li"):a(this).closest(".panel")),e.is(".connectignore")?i.ajax_ignore_request_connection(d,c,u):e.is(".connectaccept")&&i.ajax_accept_request_connection(d,c,u)}).on("click",".marknotificationread",function(b){b.preventDefault(),b.stopPropagation();var c=a(this).data("messageid");0!==a(this).parents(".dropdown-menu").length&&r(a(this).closest("li")),p([c])});var q,r=function(a){j=a,j.block({message:k})},s=function(){j&&a.isFunction(j.unblock)&&j.unblock()},t=12e4,u=function(){clearTimeout(q);var c=[n];0!==a("#allnotifications").length&&c.push(m),b.call(c),q=setTimeout(function(){u()},t)};return{initialise:function(a){parseInt(a)>=1e3&&(t=a),q=setTimeout(function(){u()},t)},reload_message_alerts:u,ajax_mark_notification_read:p}});