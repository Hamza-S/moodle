define(["jquery","theme_bootstrap/bootstrap","core/ajax","core/log","core/notification","core/templates","core/config","core/str","local_conversations/jquery.autogrow","local_conversations/jquery.blockUI"],function(a,b,c,d,e,f,g,h,i){var j=6e4,k=function(a){h.get_strings([{key:"error"},{key:"loggedout",component:"local_conversations"},{key:"reload"},{key:"cancel"}]).done(function(b){if("undefined"!=typeof a.errorcode)switch(a.errorcode){case"servicenotavailable":e.confirm(b[0],b[1],b[2],b[3],function(){window.location.reload(!0)});break;default:e.exception(a)}}).fail(function(b){e.exception(a+" "+b)})},l=function(b,d){var e={useridto:b,message:d};c.call([{methodname:"local_conversations_send_message",args:e,done:function(c){a(document).trigger("local_conversations_message_sent",{useridto:b})},fail:k}])};a(document).on("local_conversations_message_sent",function(b,c){n(),t(c.useridto),a("#new-message-search input").val("")});var m,n=function(){a("#new-message-edit").val("").trigger("change")},o=function(b){var d={useridfrom:b};clearTimeout(m),c.call([{methodname:"local_conversations_get_conversation",args:d,done:function(c){q(c.conversation_preview_cache);var d=c.messages;if(b in d){var e=f.render("local_conversations/conversation",d[b]);e.done(function(c,d){var e=a("#conversation-"+b),f=e.prop("scrollHeight"),g=e.prop("scrollTop"),h=a(c);e.after(h);var i=h.prop("scrollHeight");f!=i?(h.scrollTop(g),h.css("visibility","visible"),e.remove(),h.animate({scrollTop:i},550)):(h.remove(),0===a(".unread",h).length&&(a(".unread",e).removeClass("unread"),r(b)))})}m=setTimeout(function(){o(b)},j),a(document).trigger("local_conversations_conversation_refreshed",{useridfrom:b})},fail:k}])},p=function(a,b){c.call([{methodname:"local_conversations_mark_messages_read_by_id",args:{messageids:a},done:function(){b&&"function"==typeof b&&b()},fail:k}])},q=function(b){b.unread_conversation_count||(b.unread_conversation_count=""),a("header nav .message-count .total-count.badge").text(b.unread_conversation_count),void 0!==b.unread_conversation_preview&&f.render("local_conversations/partials_message_alert_preview",{unread_conversation_preview:b.unread_conversation_preview}).done(function(b,c){a("header nav .message-count .dropdown-menu").replaceWith(b)}).fail(e.exception),void 0!==b.users_with_unread&&b.users_with_unread.forEach(function(b,c){var d=a("li[data-userid='"+b+"']");d.hasClass("unread")||d.addClass("unread").find(".badge").hide()})},r=function(b){a("li[data-userid='"+b+"']").removeClass("unread")},s=function(){u(),a("#allmessages div.conversationbar").addClass("hidden"),a("#allmessages .message-contact-list .original").addClass("hidden"),a("#allmessages .message-contact-list .searchlist").addClass("hidden"),a("#allmessages div.newmessagebar").removeClass("hidden"),a("#allmessages .message-contact-list .searchhelp").removeClass("hidden"),a("#new-message-search input").val("").focus()},t=function(b){if(a("#allmessages div.newmessagebar").addClass("hidden"),a("#allmessages .message-contact-list .searchlist").addClass("hidden"),a("#allmessages .message-contact-list .searchhelp").addClass("hidden"),a("#allmessages div.conversationbar").removeClass("hidden"),b){var c=a("#allmessages .message-contact-list .original li[data-userid="+b+"]");if(c.length)c.find(".message-snippet").hide(),c.parent().prepend(c);else{var d=a("#allmessages .message-contact-list li[data-userid="+b+"]");a("#allmessages .original").prepend(d)}a("#allmessages .original li").removeClass("active"),a("#allmessages .original li:first > a").trigger("click"),a("#allmessages .message-contact-list .nocontactsormessages").addClass("hidden")}else if(a(window).width()>768){var e=a("#allmessages .original li.active").removeClass("active");e.length||(e=a("#allmessages .original li:first")),e.children("a").trigger("click")}a("#allmessages .message-contact-list .original").removeClass("hidden")},u=function(){var b=a(".tab-pane.active, ul.nav-tabs li.active"),c=b.data("userid");b.removeClass("active").end().find('[data-toggle="tab"]').attr("aria-expanded",!1),a("body").removeClass("modal-open-mobile"),r(c)},v=function(b,d){var e=a("div.message-contact-list");e.data("blockUI.isBlocked")||e.block({message:"<span class='glyphicon glyphicon-refresh glyphicon-refresh-animate spinning'></span>"});var f={searchstring:b};c.call([{methodname:"local_conversations_search_contacts",args:f,done:function(b){var c=a.map(b,function(a,b){return[a]});e.unblock(),d(c)},fail:k}])},w=function(b){var c=[];c.push(f.render("local_conversations/contact_list",{search:!0,mycontactswithmessages:b,hascontacts:b.length})),c=c.concat(b.map(function(a){return f.render("local_conversations/conversation_panel",a)})),a.when.apply(a,c).done(function(){a.each(arguments,function(c,d){if(0===c){var e=d.constructor===Array?d[0]:d;a("#allmessages .message-contact-list .original").addClass("hidden"),a("#allmessages .message-contact-list .searchlist").replaceWith(e).removeClass("hidden"),a("#new-message-search input").val().length>=3&&a("#allmessages .message-contact-list .searchhelp").addClass("hidden")}else if(d.constructor===Array){var f=a("#user-"+b[c-1].id+"-tab");0===f.length&&a("#allmessages .tab-content").append(d[0])}}),a(window).width()>768&&a("#allmessages .searchlist a:first").tab("show")})},x=function(b){var d={otheruserid:b};c.call([{methodname:"local_conversations_delete_conversation",args:d,done:function(b){a("#new-message").appendTo(a("body")),a(".tab-pane.active").remove(),a("li.message-contact.active").remove();var c=a("#allmessages .original li:first a");0===c.length?a("#allmessages .message-contact-list .nocontactsormessages").removeClass("hidden"):a(window).width()>768&&c.trigger("click")},fail:k}])};return a("#allmessages").on("click",".delete-conversation",function(b){b.preventDefault();var c=a(this).parents(".tab-pane.active").find("div.conversation");if(0!==c.children().length){var d=a("#confirm_delete_conversation_dialog");d.css("position","absolute"),d.appendTo(c),d.modal({backdrop:!0}),a(".modal-backdrop.in").appendTo(c).css("position","absolute")}}),a("#allmessages").on("click","#confirm_delete_conversation_dialog .btn.confirm-delete",function(b){b.preventDefault(),a("#confirm_delete_conversation_dialog").appendTo(a("body"));var c=a(".message-contact.active").data("userid");x(c)}),{initialise:function(b){parseInt(b)>=1e3&&(j=b),a("#allmessages .tab-content").on("click",".panel-heading",function(b){var c=a(b.target);c.is(".panel-heading, .fa-chevron-left")&&a(window).width()<768&&u()}),a("#allmessages").on("show.bs.tab",'a[data-toggle="tab"]',function(b){var c=a(b.target);a(window).width()<768&&a("body").addClass("modal-open-mobile");var d=a("#new-message"),e=c.parents("li.message-contact").data("userid");d.find("input[name='useridto']").val(e);var f=a(a(b.target).attr("href"));n();var g=a("div.panel-body",f).append(d);d.removeClass("hidden");var h=g.find(".conversation");if(h.scrollTop(h.prop("scrollHeight")),!c.parents("ul.searchlist").length){var i=!0,j=a(b.relatedTarget);if(j.length){var k=j.parents("li.message-contact").data("userid"),l=a("#user-"+k+"-tab div.conversation .unread").map(function(){return a(this).data("messageid")}).toArray();l.length&&(i=!1,p(l,function(){o(e)})),r(k)}i===!0&&o(e);var m=a("#user-"+e+"-tab div.conversation .unread").map(function(){return a(this).data("messageid")}).toArray();m.length&&p(m);var q="#user-"+e;history.replaceState?history.replaceState(null,null,q):location.hash=q}}),a("#new-message .btn.submit").click(function(){a(this).addClass("hidden"),a(this).parents("form").submit()}).parents("form").on("submit",function(b){var c=a(this),d=c.find("textarea[name='message']"),e=c.find("input[name='useridto']");b.isDefaultPrevented()===!1&&(l(e.val(),d.val()),r(e.val())),b.preventDefault()}),a("#new-message-edit").autoGrow().on("input propertychange change",function(){var b=a(this).siblings("button.submit");this.value.length?b.removeClass("hidden"):b.addClass("hidden")}),a("#allmessages button.newmessage").click(function(){s(),v("",w)}),a("#allmessages button.cancelnewmessage").click(function(){s(),t()}),a("#allmessages button.searchall").click(function(){var b=a("#new-message-search input").val();v(b,w)});var c=window.location.hash;c?a("#allmessages").find('.nav-tabs a[href="'+c+'-tab"]').tab("show"):a(window).width()>768&&a("#allmessages .nav-tabs a:first").tab("show"),document.body.className+=" transform-enabled",a(window).on("hashchange",function(){var b=a("#allmessages").find(".nav-tabs a[href="+window.location.hash+"-tab]");0===b.length&&location.reload(),b.tab("show")});var d,e=750;a("#new-message-search input").on("input",function(){clearTimeout(d);var b=a(this).val(),c=a("div.message-contact-list");b.length>=3?(c.data("blockUI.isBlocked")||c.block({message:"<span class='glyphicon glyphicon-refresh glyphicon-refresh-animate spinning'></span>"}),3==b.length&&v(b,w),d=setTimeout(function(){v(b,w)},e)):b?c.unblock():(s(),c.unblock())})}}});