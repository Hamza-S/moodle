define(["core/ajax","core/notification","core/templates","tool_lp/tree","jquery"],function(a,b,c,d,e){var f=[],g=0,h="",i="",j=function(a,b){var c=0,d=!1;for(a.haschildren=!1,a.children=[],c=0;c<b.length;c++)d=b[c],d.parentid==a.id&&(a.haschildren=!0,a.children.push(d),j(d,b))},k=function(k){var l=e.Deferred(),m=a.call([{methodname:"tool_lp_search_competencies",args:{searchtext:k,competencyframeworkid:g,includerelated:!0}}]);return m[0].done(function(a){f=[];var g=0;for(g=0;g<a.length;g++)f[a[g].id]=a[g];var k=[],m=!1;for(g=0;g<a.length;g++)m=a[g],0===parseInt(m.parentid,10)&&(k.push(m),j(m,a));var n={shortname:h,competencies:k};c.render("tool_lp/competencies_tree_root",n).done(function(a,b){c.replaceNodeContents(e(i),e(a).html(),b),new d(i),l.resolve(f)}).fail(b.exception)}).fail(function(a){l.reject(a)}),l.promise()};return{init:function(a,c,d,e){g=a,h=c,i=e,k(d).fail(b.exception)},getCompetencyFrameworkId:function(){return g},getCompetency:function(a){return f[a]},getCompetencyLevel:function(a){var b=this.getCompetency(a),c=b.path.replace(/^\/|\/$/g,"").split("/").length;return c},reloadCompetencies:function(){return k("").fail(b.exception)},listCompetencies:function(){return f}}});