define(["core/ajax","core/notification","core/templates","tool_lp/tree","jquery"],function(a,b,c,d,e){var f=[],g=0,h="",i="",j=!1,k=function(a,b){var c=0,d=!1;for(a.haschildren=!1,a.children=[],c=0;c<b.length;c++)d=b[c],d.parentid==a.id&&(a.haschildren=!0,a.children.push(d),k(d,b))},l=function(l){var m=e.Deferred(),n=a.call([{methodname:"tool_lp_search_competencies",args:{searchtext:l,competencyframeworkid:g,includerelated:!0}}]);return n[0].done(function(a){f=[];var g=0;for(g=0;g<a.length;g++)f[a[g].id]=a[g];var l=[],n=!1;for(g=0;g<a.length;g++)n=a[g],0===parseInt(n.parentid,10)&&(l.push(n),k(n,a));var o={shortname:h,competencies:l};c.render("tool_lp/competencies_tree_root",o).done(function(a,b){c.replaceNode(e(i),a,b),new d(i,j),m.resolve(f)}).fail(b.exception)}).fail(function(a){m.reject(a)}),m.promise()};return{init:function(a,c,d,e,f){g=a,h=c,i=e,j=f,l(d).fail(b.exception)},getCompetencyFrameworkId:function(){return g},getCompetency:function(a){return f[a]},getCompetencyLevel:function(a){var b=this.getCompetency(a),c=b.path.replace(/^\/|\/$/g,"").split("/").length;return c},reloadCompetencies:function(){return l("").fail(b.exception)},listCompetencies:function(){return f}}});