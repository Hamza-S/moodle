define(["jquery","core/log","core/str","core/templates","core/notification"],function(a,b,c,d,e){var f={DOWN:40,ENTER:13,ESCAPE:27,COMMA:188,UP:38},g=null,h=function(b,c,d){var e=a(document.getElementById(c)),f=a(document.getElementById(d)),g=f.children("[aria-hidden=false]").length;for(b%=g;0>b;)b+=g;var h=a(f.children("[aria-hidden=false]").get(b)),i=a(f.children("[role=option]")).index(h),j=d+"-"+i;f.children().attr("aria-selected",!1),h.attr("aria-selected",!0).attr("id",j),e.attr("aria-activedescendant",j)},i=function(b,c){var d=a(document.getElementById(c)),e=d.children("[aria-selected=true]"),f=d.children("[aria-hidden=false]").index(e);h(f+1,b,c)},j=function(b,c){var d=a(document.getElementById(c)),e=d.children("[aria-selected=true]"),f=d.children("[aria-hidden=false]").index(e);h(f-1,b,c)},k=function(b,c,d){var e=a(document.getElementById(b)),f=a(document.getElementById(c));e.attr("aria-expanded",!1).attr("aria-activedescendant",d),f.hide().attr("aria-hidden",!0)},l=function(b,c,f,g,i,j){var k=a(document.getElementById(c)),l=a(document.getElementById(f)),m=!1,n=[];g.children("option").each(function(b,c){n[b]={label:c.innerHTML,value:a(c).attr("value")}}),d.render("core/form-autocomplete-suggestions",{inputId:c,suggestionsId:f,options:n,multiple:i}).done(function(d){l.replaceWith(d),l=a(document.getElementById(f)),l.show().attr("aria-hidden",!1),l.children().each(function(c,d){d=a(d),d.text().indexOf(b)>-1?(d.show().attr("aria-hidden",!1),m=!0):d.hide().attr("aria-hidden",!0)}),m?(k.attr("aria-expanded",!0),j||h(0,c,f)):(l.hide(),l.attr("aria-hidden",!0),k.attr("aria-expanded",!1))}).fail(e.exception)},m=function(b,c,f,g,h){var i=a(document.getElementById(b)),j=i.val(),l=!1;if(g||h.children("option").prop("selected",!1),h.children("option").each(function(b,c){a(c).attr("value")==j&&(l=!0,a(c).prop("selected",!a(c).prop("selected")))}),!l){var m=a("<option>");m.append(j),m.attr("value",j),h.append(m),m.prop("selected",!0)}var n=a(document.getElementById(f)),o=[];h.children("option").each(function(b,c){a(c).prop("selected")&&o.push({label:a(c).html(),value:a(c).attr("value")})});var p={selectionId:f,items:o};d.render("core/form-autocomplete-selection",p).done(function(b){n.empty().append(a(b).html())}).fail(e.exception),i.val(""),k(b,c,f),h.change()},n=function(b,c){var f=[],g=a(document.getElementById(b));c.children("option").each(function(b,c){a(c).prop("selected")&&f.push({label:a(c).html(),value:a(c).attr("value")})});var h={selectionId:b,items:f};d.render("core/form-autocomplete-selection",h).done(function(b){g.empty().append(a(b).html())}).fail(e.exception),c.change()},o=function(b,c,d,e,f){var g=a(document.getElementById(b)),h=a(document.getElementById(c)),i=h.children("[aria-selected=true]").attr("data-value");e||f.children("option").prop("selected",!1),f.children("option").each(function(b,c){a(c).attr("value")==i&&a(c).prop("selected",!a(c).prop("selected"))}),n(d,f),g.val(""),k(b,c,d)},p=function(b,c,d,f,g,h,i,j){var k=a(b.currentTarget).val();j.transport(c,k,function(b){var e=j.processResults(c,b);g.children("options").each(function(a,b){b.prop("selected")||(b.detach(),b.destroy())}),a.each(e,function(b,c){var d=a("<option>");d.append(c.label),d.attr("value",c.value),g.append(d),d.prop("selected",!0)}),l("",d,f,g,h,i)},e.exception)},q=function(b,c,d,e,p,q,r){var s=a(document.getElementById(b));s.on("keydown",function(d){switch(d.keyCode){case f.DOWN:return"true"===s.attr("aria-expanded")?i(b,c):l(s.val(),b,c,p,q,r),d.preventDefault(),!1;case f.COMMA:return r&&m(b,c,e,q,p),d.preventDefault(),!1;case f.UP:return j(b,c),d.preventDefault(),!1;case f.ENTER:var g=a(document.getElementById(c));return"true"===s.attr("aria-expanded")&&g.children("[aria-selected=true]").length>0?o(b,c,e,q,p):r&&m(b,c,e,q,p),d.preventDefault(),!1;case f.ESCAPE:return"true"===s.attr("aria-expanded")&&k(b,c,e),d.preventDefault(),!1}return!0}),s.on("blur focus",function(){g=window.setTimeout(function(){k(b,c,e)},500)});var t=a(document.getElementById(d));t.on("click",function(){g&&window.clearTimeout(g),l(s.val(),b,c,p,q,r)});var u=a(document.getElementById(c));u.parent().on("click","[role=option]",function(d){var f=a(d.currentTarget).closest("[role=option]"),g=a(document.getElementById(c)),i=g.children("[aria-hidden=false]").index(f);h(i,b,c),o(b,c,e,q,p)});var v=a(document.getElementById(e));v.parent().on("click","[role=listitem]",function(b){var c=a(b.currentTarget).attr("data-value");q&&p.children("option").each(function(b,d){a(d).attr("value")==c&&a(d).prop("selected",!a(d).prop("selected"))}),n(e,p)}),s.on("input",function(d){var e=a(d.currentTarget).val();l(e,b,c,p,q,r)})};return{enhance:function(c,e,f,g){"undefined"==typeof e&&(e=!1),"undefined"==typeof f&&(f=!1);var h=a(c);if(!h)return b.debug("Selector not found: "+c),!1;h.hide().attr("aria-hidden",!0);var i=h.attr("id"),j=h.attr("multiple"),k="form-autocomplete-input-"+a.now(),l="form-autocomplete-suggestions-"+a.now(),m="form-autocomplete-selection-"+a.now(),o="form-autocomplete-downarrow-"+a.now(),r=a("[for="+i+"]"),s=[];h.children("option").each(function(b,c){s[b]={label:c.innerHTML,value:a(c).attr("value")}});var t=d.render("core/form-autocomplete-input",{downArrowId:o,inputId:k,suggestionsId:l,selectionId:m,placeholder:g,multiple:j}),u=d.render("core/form-autocomplete-suggestions",{inputId:k,suggestionsId:l,options:s,multiple:j}),v=d.render("core/form-autocomplete-selection",{selectionId:m,items:[]});a.when(t,u,v).done(function(b,d,g){h.after(g),h.after(d),h.after(b),r.attr("for",k),q(k,l,o,m,h,j,e);var i=a(document.getElementById(k)),s=a(document.getElementById(l));s.hide().attr("aria-hidden",!0),f&&require([f],function(a){var b=function(b){p(b,c,k,l,h,j,e,a)};i.on("input keypress",b)}),n(m,h)})}}});