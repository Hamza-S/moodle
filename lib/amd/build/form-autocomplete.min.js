define(["jquery","core/log","core/str","core/templates","core/notification"],function(a,b,c,d,e){var f={DOWN:40,ENTER:13,SPACE:32,ESCAPE:27,COMMA:44,UP:38},g=a.now(),h="showmore",i=function(b,c){var d=a(document.getElementById(c.selectionId)),e=d.children("[aria-selected=true]").length;for(b%=e;b<0;)b+=e;var f=a(d.children("[aria-selected=true]").get(b)),g=c.selectionId+"-"+b;d.children().attr("data-active-selection",!1).attr("id",""),f.attr("data-active-selection",!0).attr("id",g),d.attr("aria-activedescendant",g)},j=function(b,c,f){var g=[],h=a(document.getElementById(c.selectionId)),j=h.attr("aria-activedescendant"),k=!1;j&&(k=a(document.getElementById(j)).attr("data-value")),f.children("option").each(function(b,c){if(a(c).prop("selected")){var d;d=a(c).data("html")?a(c).data("html"):a(c).html(),g.push({label:d,value:a(c).attr("value")})}});var l=a.extend({items:g},b,c);d.render("core/form_autocomplete_selection",l).done(function(b){h.empty().append(a(b).html()),k!==!1&&h.children("[aria-selected=true]").each(function(b,d){a(d).attr("data-value")===k&&i(b,c)})}).fail(e.exception)},k=function(a){"undefined"!=typeof M.core_formchangechecker&&M.core_formchangechecker.set_form_changed(),a.change()},l=function(b,c,d,e){var f=a(d).attr("data-value");b.multiple&&e.children("option").each(function(b,c){a(c).attr("value")==f&&(a(c).prop("selected",!1),a(c).attr("data-iscustom")&&a(c).remove())}),j(b,c,e),k(e)},m=function(b,c){var d=a(document.getElementById(c.inputId)),e=a(document.getElementById(c.suggestionsId)),f=e.children("[aria-hidden=false]").length;for(b%=f;b<0;)b+=f;var g=a(e.children("[aria-hidden=false]").get(b)),h=a(e.children("[role=option]")).index(g),i=c.suggestionsId+"-"+h;e.children().attr("aria-selected",!1).attr("id",""),g.attr("aria-selected",!0).attr("id",i),d.attr("aria-activedescendant",i);var j=g.offset().top-e.offset().top+e.scrollTop()-e.height()/2;e.animate({scrollTop:j},100)},n=function(b){var c=a(document.getElementById(b.suggestionsId)),d=c.children("[aria-selected=true]"),e=c.children("[aria-hidden=false]").index(d);m(e+1,b)},o=function(b){var c=a(document.getElementById(b.selectionId)),d=c.children("[data-active-selection=true]");if(!d)return void i(0,b);var e=c.children("[aria-selected=true]").index(d);i(e-1,b)},p=function(b){var c=a(document.getElementById(b.selectionId)),d=c.children("[data-active-selection=true]");if(!d)return void i(0,b);var e=c.children("[aria-selected=true]").index(d);i(e+1,b)},q=function(b){var c=a(document.getElementById(b.suggestionsId)),d=c.children("[aria-selected=true]"),e=c.children("[aria-hidden=false]").index(d);m(e-1,b)},r=function(b){var c=a(document.getElementById(b.inputId)),d=a(document.getElementById(b.suggestionsId));c.attr("aria-expanded",!1).attr("aria-activedescendant",b.selectionId),d.hide().attr("aria-hidden",!0)},s=function(b,f,g,i,j){var k=a(document.getElementById(f.inputId)),l=a(document.getElementById(f.suggestionsId)),n=!1,o=[];i.children("option").each(function(b,c){a(c).prop("selected")!==!0&&(o[o.length]={label:c.innerHTML,value:a(c).attr("value")})}),f.moreAvailable===!0&&(o[o.length]={label:b.viewMoreString,value:h});var p=f.caseSensitive?g:g.toLocaleLowerCase(),q=a.extend({options:o},b,f);d.render("core/form_autocomplete_suggestions",q).done(function(d){l.replaceWith(d),l=a(document.getElementById(f.suggestionsId)),l.show().attr("aria-hidden",!1),l.children().each(function(c,d){d=a(d),b.caseSensitive&&d.text().indexOf(p)>-1||!b.caseSensitive&&d.text().toLocaleLowerCase().indexOf(p)>-1?(d.show().attr("aria-hidden",!1),n=!0):d.hide().attr("aria-hidden",!0)}),k.attr("aria-expanded",!0),i.attr("data-notice")?l.html(i.attr("data-notice")):n?b.tags||("undefined"==typeof j&&(j=0),m(j,f)):c.get_string("nosuggestions","form").done(function(a){l.html(a)})}).fail(e.exception)},t=function(b,c,d){var e=a(document.getElementById(c.inputId)),f=e.val(),g=f.split(","),h=!1;a.each(g,function(c,e){if(e=e.trim(),""!==e&&(b.multiple||d.children("option").prop("selected",!1),d.children("option").each(function(b,c){a(c).attr("value")==e&&(h=!0,a(c).prop("selected",!0))}),!h)){var f=a("<option>");f.append(document.createTextNode(e)),f.attr("value",e),d.append(f),f.prop("selected",!0),f.attr("data-iscustom",!0)}}),j(b,c,d),k(d),e.val(""),r(c)},u=function(b,c,d){var e=a(document.getElementById(c.inputId)),f=a(document.getElementById(c.suggestionsId)),g=f.children("[aria-selected=true]").attr("data-value");b.multiple||d.children("option").prop("selected",!1),d.children("option").each(function(b,c){a(c).attr("value")==g&&a(c).prop("selected",!0)}),j(b,c,d),k(d),g===h?require([b.ajax],function(a){var g,h,i=null;e.focus(),a.showMore(),g=f.children("[aria-selected=true]"),h=f.children("[aria-hidden=false]").index(g),v(i,b,c,d,a,h)}):b.closeSuggestionsOnSelect?(e.val(""),r(c)):(e.focus(),s(b,c,e.val(),d))},v=function(b,c,d,f,g,h){var i="form-autocomplete-updateajax";M.util.js_pending(i);var j=a(document.getElementById(d.inputId)),k=j.val();g.transport(c.selector,k,function(b,e){var j=g.processResults(c.selector,b),k=[];if("undefined"!=typeof e&&(d.moreAvailable=e===!0),f.children("option").each(function(b,c){c=a(c),c.prop("selected")?k.push(String(c.attr("value"))):c.remove()}),!c.multiple&&0===f.children("option").length){var l=a("<option>");f.append(l)}a.isArray(j)?(a.each(j,function(b,c){if(k.indexOf(String(c.value))===-1){var d=a("<option>");d.append(c.label),d.attr("value",c.value),f.append(d)}}),f.attr("data-notice","")):f.attr("data-notice",j),s(c,d,"",f,h),M.util.js_complete(i)},function(a){M.util.js_complete(i),e.exception(a)})},w=function(b,c,d){var e=a(document.getElementById(c.inputId));if(e.on("keydown",function(g){var h="form-autocomplete-addnav-"+c.inputId+"-"+g.keyCode;switch(M.util.js_pending(h),g.keyCode){case f.DOWN:return b.showSuggestions?("true"===e.attr("aria-expanded")?n(c):!e.val()&&b.ajax?require([b.ajax],function(a){v(g,b,c,d,a)}):s(b,c,e.val(),d),g.preventDefault(),M.util.js_complete(h),!1):(M.util.js_complete(h),!0);case f.UP:return q(c),g.preventDefault(),M.util.js_complete(h),!1;case f.ENTER:var i=a(document.getElementById(c.suggestionsId));return"true"===e.attr("aria-expanded")&&i.children("[aria-selected=true]").length>0?u(b,c,d):b.tags&&t(b,c,d),g.preventDefault(),M.util.js_complete(h),!1;case f.ESCAPE:return"true"===e.attr("aria-expanded")&&r(c),g.preventDefault(),M.util.js_complete(h),!1}return M.util.js_complete(h),!0}),e.on("keypress",function(a){var e="form-autocomplete-keypress-"+a.keyCode;return M.util.js_pending(e),a.keyCode===f.COMMA?(b.tags&&t(b,c,d),a.preventDefault(),M.util.js_complete(e),!1):(M.util.js_complete(e),!0)}),e.on("behat:set-value",function(){var f=a(document.getElementById(c.suggestionsId)),g="form-autocomplete-behat";M.util.js_pending(g),"true"===e.attr("aria-expanded")&&f.children("[aria-selected=true]").length>0?u(b,c,d):b.tags&&t(b,c,d),M.util.js_complete(g)}),e.on("blur",function(){var f="form-autocomplete-blur";M.util.js_pending(f),window.setTimeout(function(){var g=a(document.activeElement);g.attr("id")!=e.attr("id")&&(b.tags&&t(b,c,d),r(c)),M.util.js_complete(f)},500)}),b.showSuggestions){var g=a(document.getElementById(c.downArrowId));g.on("click",function(a){var f="form-autocomplete-show-suggestions";M.util.js_pending(f),e.focus(),!e.val()&&b.ajax?require([b.ajax],function(e){v(a,b,c,d,e)}):s(b,c,e.val(),d),M.util.js_complete(f)})}var h=a(document.getElementById(c.suggestionsId));h.parent().on("click","[role=option]",function(e){var f="form-autocomplete-parent";M.util.js_pending(f);var g=a(e.currentTarget).closest("[role=option]"),h=a(document.getElementById(c.suggestionsId)),i=h.children("[aria-hidden=false]").index(g);m(i,c),u(b,c,d),M.util.js_complete(f)});var i=a(document.getElementById(c.selectionId));i.on("click","[role=listitem]",function(e){var f="form-autocomplete-clicks";M.util.js_pending(f);var g=a(e.currentTarget);l(b,c,g,d),M.util.js_complete(f)}),i.on("keydown",function(e){var g="form-autocomplete-keydown-"+e.keyCode;switch(M.util.js_pending(g),e.keyCode){case f.DOWN:return p(c),e.preventDefault(),M.util.js_complete(g),!1;case f.UP:return o(c),e.preventDefault(),M.util.js_complete(g),!1;case f.SPACE:case f.ENTER:var h=a(document.getElementById(c.selectionId)).children("[data-active-selection=true]");return h&&(l(b,c,h,d),e.preventDefault()),M.util.js_complete(g),!1}return M.util.js_complete(g),!0}),b.showSuggestions&&(b.ajax?require([b.ajax],function(a){var f=null,g="autocomplete-throttledhandler",h=function(e){v(e,b,c,d,a),M.util.js_complete(g)},i=function(a){null!==f?(window.clearTimeout(f),f=null):M.util.js_pending(g),f=window.setTimeout(h.bind(this,a),300)};e.on("input",i)}):e.on("input",function(e){var f=a(e.currentTarget).val(),g=a(e.currentTarget).data("last-value");g!==f&&s(b,c,f,d),a(e.currentTarget).data("last-value",f)}))};return{enhance:function(f,h,i,k,l,m,n,o){var p={selector:f,tags:!1,ajax:!1,placeholder:k,caseSensitive:!1,showSuggestions:!0,noSelectionString:n},q="autocomplete-setup-"+f;M.util.js_pending(q),"undefined"!=typeof h&&(p.tags=h),"undefined"!=typeof i&&(p.ajax=i),"undefined"!=typeof l&&(p.caseSensitive=l),"undefined"!=typeof m&&(p.showSuggestions=m),"undefined"==typeof n&&c.get_string("noselection","form").done(function(a){p.noSelectionString=a}).fail(e.exception),"undefined"==typeof viewMoreString&&c.get_string("viewmore","core").done(function(a){p.viewMoreString=a}).fail(e.exception);var r=a(f);if(!r)return b.debug("Selector not found: "+f),M.util.js_complete(q),!1;r.css("visibility","hidden").attr("aria-hidden",!0);var s={selectId:r.attr("id"),inputId:"form_autocomplete_input-"+g,suggestionsId:"form_autocomplete_suggestions-"+g,selectionId:"form_autocomplete_selection-"+g,downArrowId:"form_autocomplete_downarrow-"+g,moreAvailable:"undefined"};g++,p.multiple=r.attr("multiple"),"undefined"!=typeof o?p.closeSuggestionsOnSelect=o:p.closeSuggestionsOnSelect=!p.multiple;var t=a("[for="+s.selectId+"]"),u=[];r.children("option").each(function(b,c){u[b]={label:c.innerHTML,value:a(c).attr("value")}});var v=a.extend({},p,s);v.options=u,v.items=[];var x=d.render("core/form_autocomplete_input",v),y=d.render("core/form_autocomplete_suggestions",v),z=d.render("core/form_autocomplete_selection",v);return a.when(x,y,z).then(function(b,c,d){r.hide(),r.after(c),r.after(b),r.after(d),t.attr("for",s.inputId),w(p,s,r);var e=a(document.getElementById(s.suggestionsId));return e.hide().attr("aria-hidden",!0),j(p,s,r),M.util.js_complete(q),!0}).fail(function(a){M.util.js_complete(q),e.exception(a)})}}});