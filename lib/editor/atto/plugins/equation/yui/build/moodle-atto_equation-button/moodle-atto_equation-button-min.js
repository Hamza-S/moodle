YUI.add("moodle-atto_equation-button",function(e,t){var n="atto_equation",r={EQUATION_TEXT:"atto_equation_equation",EQUATION_PREVIEW:"atto_equation_preview",SUBMIT:"atto_equation_preview",LIBRARY:"atto_equation_library",LIBRARY_GROUP_PREFIX:"atto_equation_library"},i={EQUATION_TEXT:"#"+r.EQUATION_TEXT,EQUATION_PREVIEW:"#"+r.EQUATION_PREVIEW,SUBMIT:"#"+r.SUBMIT,LIBRARY_BUTTON:"#"+r.LIBRARY+" button"},s={FORM:'<form class="atto_form">{{{library}}}<label for="{{CSS.EQUATION_TEXT}}">{{get_string "editequation" component}}</label><textarea class="fullwidth" id="{{CSS.EQUATION_TEXT}}" rows="8"></textarea><br/><p>{{{get_string "editequation_desc" component}}}</p><label for="{{CSS.EQUATION_PREVIEW}}">{{get_string "preview" component}}</label><div class="fullwidth" id="{{CSS.EQUATION_PREVIEW}}"></div><div class="mdl-align"><br/><button id="{{CSS.SUBMIT}}">{{get_string "saveequation" component}}</button></div></form>',LIBRARY:'<div id="{{CSS.LIBRARY}}"><ul>{{#each library}}<li><a href="#{{../CSS.LIBRARY_GROUP_PREFIX}}{{@key}}">{{get_string groupname ../component}}</a></li>{{/each}}</ul><div>{{#each library}}<div id="{{../CSS.LIBRARY_GROUP_PREFIX}}{{@key}}">{{#split "\n" elements}}<button data-tex="{{this}}" title="{{this}}">$${{this}}$$</button>{{/split}}</div>{{/each}}</div></div>'};e.namespace("M.atto_equation").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_lastCursorPos:0,initializer:function(){this.get("texfilteractive")&&(this.addButton({icon:"e/math",callback:this._displayDialogue}),this.get("host").on("atto:selectionchanged",function(){this._resolveEquation()?this.highlightButton():this.unHighlightButton()},this))},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;var t=this.getDialogue({headerContent:M.util.get_string("pluginname",n),focusAfterHide:!0}),r=this._getDialogueContent();t.set("bodyContent",r);var i=new e.TabView({srcNode:r});i.render(),t.show();var s=this._resolveEquation();s&&r.one("#atto_equation_equation").set("text",s),this._updatePreview(!1)},_resolveEquation:function(){var t=this.get("host").getSelectionParentNode(),n,r;return t?(n=e.one(t).get("text"),pattern=/\$\$[\S\s]*\$\$/,r=pattern.exec(n),r&&r.length?(r=r.pop(),r=r.substring(2,r.length-2),r):!1):!1},_setEquation:function(t){var n,r,i,s,o,u,a=this.get("host");t.preventDefault(),his.getDialogue({focusAfterHide:null}).hide(),n=t.currentTarget.ancestor(".atto_form").one("textarea"),u=n.get("value"),u!==""&&(a.setSelection(this._currentselection),u="$$ "+u.trim()+" $$",r=e.one(a.getSelectionParentNode()),i=r.get("text"),s=/\$\$[\S\s]*\$\$/,o=s.exec(i),o&&o.length?(o=o.pop(),i=i.replace(o,"$$"+u+"$$"),r.set("text",i)):a.insertContentAtFocusPoint(u),this.markUpdated())},_updatePreview:function(t){var n=e.one("#atto_equation_equation"),r=n.get("value"),i,s,o=n.get("selectionStart"),u="",a="\\square ",f;t&&t.preventDefault(),o||(o=0);while(r.charAt(o)==="\\"&&o>0)o-=1;f=/[\w\{\}]/;while(f.test(r.charAt(o))&&o<r.length)o+=1;this._lastCursorPos=o,r=u+r.substring(0,o)+a+r.substring(o),i=M.cfg.wwwroot+"/lib/editor/atto/plugins/equation/ajax.php",params={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",text:"$$ "+r+" $$"},s=e.io(i,{sync:!0,data:params}),s.status===200&&e.one("#atto_equation_preview").setHTML(s.responseText)},_getDialogueContent:function(){var t=this._getLibraryContent(),o=e.Handlebars.compile(s.FORM),u=e.Node.create(o({component:n,library:t,CSS:r}));return u.one(i.SUBMIT).on("click",this._setEquation,this),u.one(i.EQUATION_TEXT).on("valuechange, keyup, mouseup",this._updatePreview,this),u.delegate("click",this._selectLibraryItem,i.LIBRARY_BUTTON,this),u},_selectLibraryItem:function(e){var t=e.currentTarget.getAttribute("data-tex");e.preventDefault(),input=e.currentTarget.ancestor(".atto_form").one("textarea"),value=input.get("value"),value=value.substring(0,this._lastCursorPos)+t+value.substring(this._lastCursorPos,value.length),input.set("value",value),input.focus();var n=this._lastCursorPos+t.length,r=input.getDOMNode();if(typeof r.selectionStart=="number")r.selectionStart=r.selectionEnd=n;else if(typeof r.createTextRange!="undefined"){var i=r.createTextRange();i.moveToPoint(n),i.select()}this.updatePreview(!1)},_getLibraryContent:function(){var t=e.Handlebars.compile(s.LIBRARY),i=this.get("library"),o="";e.Handlebars.registerHelper("split",function(e,t){var n,r,i;if(typeof e=="undefined"||typeof t=="undefined")return"";i="",n=t.split(e);while(n.length>0)r=n.shift(),i+=options.fn(r);return i}),o=t({component:n,library:i,CSS:r});var u=M.cfg.wwwroot+"/lib/editor/atto/plugins/equation/ajax.php",a={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",text:o};return preview=e.io(u,{sync:!0,data:a,method:"POST"}),preview.status===200&&(o=preview.responseText),o}},{ATTRS:{texfilteractive:{value:!1},contextid:{value:null},library:{value:{}}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","io","event-valuechange","tabview"]});
