YUI.add("moodle-assignfeedback_editpdf-editor",function(e,t){POINT=function(e,t){this.x=e,this.y=t},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.point=POINT,EDIT=function(){this.start=!1,this.end=!1,this.starttime=0,this.annotationstart=!1,this.tool="comment",this.commentcolour="yellow",this.annotationcolour="red",this.path=[]},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.edit=EDIT,DRAWABLE=function(e){this.editor=e,this.shapes=[],this.nodes=[],this.erase=function(){if(this.shapes)while(this.shapes.length>0)this.editor.graphic.removeShape(this.shapes.pop());if(this.nodes)while(this.nodes.length>0)this.nodes.pop().remove()}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.drawable=DRAWABLE;var n="Dropdown menu",r;r=function(e){e.draggable=!1,e.centered=!1,e.width="auto",e.lightbox=!1,e.visible=!1,e.zIndex=100,e.footerContent="",r.superclass.constructor.apply(this,[e])},e.extend(r,M.core.dialogue,{initializer:function(t){var n,i,s,o;r.superclass.initializer.call(this,t),o=this.get("boundingBox"),o.addClass("assignfeedback_editpdf_dropdown"),n=this.get("buttonNode"),i=this.bodyNode,s=e.Node.create("<h3/>"),s.addClass("accesshide"),s.setHTML(this.get("headerText")),i.prepend(s),i.on("clickoutside",function(e){e.target!==n&&e.target.ancestor()!==n&&(e.preventDefault(),this.hide())},this),n.on("click",this.show,this),n.on("key",this.show,"enter,space",this)},show:function(){var t=this.get("buttonNode");result=r.superclass.show.call(this),this.align(t,[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL])}},{NAME:n,ATTRS:{headerText:{value:""},buttonNode:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.dropdown=r;var s="Colourpicker",o;o=function(e){o.superclass.constructor.apply(this,[e])},e.extend(o,M.assignfeedback_editpdf.dropdown,{initializer:function(t){var n=e.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),r;e.each(this.get("colours"),function(t,r){var i,s,o,u;o=M.util.get_string(r,"assignfeedback_editpdf"),u=M.util.image_url("commentcolour","assignfeedback_editpdf"),i=e.Node.create('<button><img alt="'+o+'" src="'+u+'"/></button>'),i.setAttribute("data-colour",r),i.setAttribute("data-rgb",t),i.addClass("colour_"+r),i.setStyle("backgroundImage","none"),i.one("img").setStyle("background",t),r==="clear"&&i.one("img").setStyle("borderStyle","dashed"),s=e.Node.create("<li/>"),s.append(i),n.append(s)},this),r=e.Node.create("<div/>"),n.delegate("click",this.callback_handler,"button",this),n.delegate("key",this.callback_handler,"down:13","button",this),this.set("headerText",M.util.get_string("colourpicker","assignfeedback_editpdf")),r.append(n),this.set("bodyContent",r),o.superclass.initializer.call(this,t)},callback_handler:function(t){var n=this.get("callback"),r=this.get("context"),i;this.hide(),i=e.bind(n,r,t),i()}},{NAME:s,ATTRS:{colours:{value:{}},callback:{value:null},context:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.colourpicker=o;var u=M.cfg.wwwroot+"/mod/assign/feedback/editpdf/ajax.php",a={DIALOGUE:"assignfeedback_editpdf_widget"},f={PREVIOUSBUTTON:"."+a.DIALOGUE+" .navigate-previous-button",NEXTBUTTON:"."+a.DIALOGUE+" .navigate-next-button",SEARCHCOMMENTSBUTTON:"."+a.DIALOGUE+" .searchcommentsbutton",SEARCHFILTER:".assignfeedback_editpdf_searchcomments input",SEARCHCOMMENTSLIST:".assignfeedback_editpdf_searchcomments ul",PAGESELECT:"."+a.DIALOGUE+" .navigate-page-select",LOADINGICON:"."+a.DIALOGUE+" .loading",DRAWINGREGION:"."+a.DIALOGUE+" .drawingregion",DRAWINGCANVAS:"."+a.DIALOGUE+" .drawingcanvas",SAVE:"."+a.DIALOGUE+" .savebutton",COMMENTCOLOURBUTTON:"."+a.DIALOGUE+" .commentcolourbutton",COMMENTMENU:" .commentdrawable a",ANNOTATIONCOLOURBUTTON:"."+a.DIALOGUE+" .annotationcolourbutton",DELETEANNOTATIONBUTTON:"."+a.DIALOGUE+" .deleteannotationbutton",STAMPSBUTTON:"."+a.DIALOGUE+" .currentstampbutton",DIALOGUE:"."+a.DIALOGUE},l="rgba(200, 200, 255, 0.9)",c="rgba(200, 200, 255, 0.5)",h={white:"rgb(255,255,255)",yellow:"rgb(255,255,176)",red:"rgb(255,176,176)",green:"rgb(176,255,176)",blue:"rgb(208,208,255)",clear:"rgba(255,255,255, 0)"},p={white:"rgb(255,255,255)",yellow:"rgb(255,255,0)",red:"rgb(255,0,0)",green:"rgb(0,255,0)",blue:"rgb(0,0,255)",black:"rgb(0,0,0)"},d=300,v={comment:"."+a.DIALOGUE+" .commentbutton",pen:"."+a.DIALOGUE+" .penbutton",line:"."+a.DIALOGUE+" .linebutton",rectangle:"."+a.DIALOGUE+" .rectanglebutton",oval:"."+a.DIALOGUE+" .ovalbutton",stamp:"."+a.DIALOGUE+" .stampbutton",select:"."+a.DIALOGUE+" .selectbutton",highlight:"."+a.DIALOGUE+" .highlightbutton"},m=4;Stamp=function(){this.url="",this.width=0,this.height=0},EDITOR=function(){EDITOR.superclass.constructor.apply(this,arguments)},EDITOR.prototype={dialogue:null,pagecount:0,currentpage:0,pages:[],loadingicon:null,pageimage:null,graphic:null,currentedit:new M.assignfeedback_editpdf.edit,currentdrawable:!1,drawables:[],commentmenu:null,currentcomment:null,currentannotation:null,currentcommentmenulink:null,quicklist:[],searchcommentswindow:null,currentstamp:null,stamps:[],currentstampnodeid:null,currentstamppicker:null,initializer:function(){var t,n;t=e.one("#"+this.get("linkid")),t.on("click",this.link_handler,this),t.on("key",this.link_handler,"down:13",this),n=e.one("#"+this.get("deletelinkid")),n.on("click",this.delete_link_handler,this),n.on("key",this.delete_link_handler,"down:13",this),this.currentedit.start=!1,this.currentedit.end=!1},refresh_button_state:function(){var t,n;t=e.one(f.COMMENTCOLOURBUTTON),t.setStyle("backgroundImage","none"),t.one("img").setStyle("background",h[this.currentedit.commentcolour]),this.currentedit.commentcolour==="clear"?t.one("img").setStyle("borderStyle","dashed"):t.one("img").setStyle("borderStyle","solid"),t=e.one(f.ANNOTATIONCOLOURBUTTON),t.setStyle("backgroundImage","none"),t.one("img").setStyle("backgroundColor",p[this.currentedit.annotationcolour])
,n=e.one(v[this.currentedit.tool]),n.addClass("assignfeedback_editpdf_selectedbutton"),n.setAttribute("aria-pressed","true")},link_handler:function(t){var n,r;t.preventDefault(),this.dialogue?this.dialogue.show():(this.dialogue=new M.core.dialogue({headerContent:this.get("header"),bodyContent:this.get("body"),footerContent:this.get("footer"),width:"840px",visible:!0}),this.dialogue.centerDialogue(),this.dialogue.get("boundingBox").addClass(a.DIALOGUE),this.loadingicon=e.one(f.LOADINGICON),n=e.one(f.DRAWINGCANVAS),this.graphic=new e.Graphic({render:f.DRAWINGCANVAS}),n.on("gesturemovestart",this.edit_start,null,this),n.on("gesturemove",this.edit_move,null,this),n.on("gesturemoveend",this.edit_end,null,this),r=e.one(f.DRAWINGREGION),r.delegate("click",this.open_comment_menu,f.COMMENTMENU,this),r.delegate("key",this.open_comment_menu,"down:13",f.COMMENTMENU,this),this.refresh_button_state()),this.load_all_pages()},delete_link_handler:function(t){var n,r;t.preventDefault();var i=u,s;s={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"deletefeedbackdocument",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(){n=e.one("#"+this.get("downloadlinkid")),r=e.one("#"+this.get("deletelinkid")),n.addClass("hidden"),r.addClass("hidden")},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(i,s)},load_all_pages:function(){var t=u,n;n={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"loadallpages",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(e,t){this.all_pages_loaded(t.responseText)},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(t,n)},all_pages_loaded:function(t){var n;try{n=e.JSON.parse(t)}catch(r){return this.dialogue.hide(),new M.core.exception(r)}this.pagecount=n.pagecount,this.pages=n.pages,this.load_quicklist(),this.setup_navigation(),this.setup_toolbar(),this.change_page(),this.setup_save_cancel()},setup_stamp_picker:function(t,n,r){var i=e.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),s,o,u,a;e.each(n,function(t,n){var r,s;r=e.Node.create("<button/>"),r.setAttribute("title",M.util.get_string("stamp","assignfeedback_editpdf",n)),r.setAttribute("stampindex",n),r.setStyle("backgroundImage","url('"+t.url+"')"),r.setStyle("backgroundSize","100% 100%"),r.setStyle("backgroundRepeat","no-repeat"),r.setStyle("height","30px"),r.setStyle("width","40px"),r.setStyle("borderStyle","solid"),s=e.Node.create("<li/>"),s.append(r),i.append(s)},this),o=e.Node.create("<div/>"),i.delegate("click",r,"button",this),i.delegate("key",r,"down:13","button",this),u=e.Node.create("<h3/>"),u.addClass("accesshide"),u.setHTML(M.util.get_string("stamppicker","assignfeedback_editpdf")),o.append(u),o.append(i),s=new M.core.dialogue({extraClasses:["assignfeedback_editpdf_colourpicker"],draggable:!1,centered:!1,width:"auto",lightbox:!1,visible:!1,bodyContent:o,footerContent:"",align:{node:t,points:[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]}}),o.on("clickoutside",function(e){e.target!==t&&e.target.ancestor()!==t&&(e.preventDefault(),s.hide())}),a=function(){this.currentstamppicker=s,s.show()},t.on("click",a,this),t.on("key",a,"down:13",this)},setup_toolbar:function(){var t,n,r,i,s,o,u,a;e.each(v,function(n,r){t=e.one(n),t.on("click",this.handle_toolbutton,this,r),t.on("key",this.handle_toolbutton,"down:13",this,r),t.setAttribute("aria-pressed","false")},this),i=e.one(f.SEARCHCOMMENTSBUTTON),i.on("click",this.open_search_comments,this),i.on("key",this.open_search_comments,"down:13",this),n=e.one(f.COMMENTCOLOURBUTTON),a=new M.assignfeedback_editpdf.colourpicker({buttonNode:n,colours:h,callback:function(e){var t=e.target.getAttribute("data-colour");t||(t=e.target.ancestor().getAttribute("data-colour")),this.currentedit.commentcolour=t,this.refresh_button_state()},context:this}),r=e.one(f.ANNOTATIONCOLOURBUTTON),a=new M.assignfeedback_editpdf.colourpicker({buttonNode:r,colours:p,callback:function(e){var t=e.target.getAttribute("data-colour");t||(t=e.target.ancestor().getAttribute("data-colour")),this.currentedit.annotationcolour=t,this.refresh_button_state()},context:this}),o=this.get("stampfileurls"),u=function(){this.rootcontext.stamps[this.stampindex].height=this.height,this.rootcontext.stamps[this.stampindex].width=this.width};for(s=0;s<o.length;s++){var l=new Stamp;l.url=M.cfg.wwwroot+stampfileurl,this.stamps[s]=l;var c=new Image;c.src=M.cfg.wwwroot+stampfileurl,c.stampindex=s,c.rootcontext=this,c.onload=u}stampsbutton=e.one(f.STAMPSBUTTON),o.length<=0?stampsbutton.setAttribute("disabled","true"):(this.currentstamp=0,stampsbutton.setStyle("backgroundImage","url('"+this.stamps[this.currentstamp].url+"')"),stampsbutton.setStyle("backgroundSize","100% 100%"),stampsbutton.setStyle("backgroundRepeat","no-repeat"),this.setup_stamp_picker(stampsbutton,this.stamps,function(t){this.currentstamp=t.target.getAttribute("stampindex"),button=e.one(f.STAMPSBUTTON),button.setStyle("backgroundImage","url('"+this.stamps[this.currentstamp].url+"')"),button.setStyle("backgroundSize","100% 100%"),button.setStyle("backgroundRepeat","no-repeat"),this.currentstamppicker.hide()}))},handle_toolbutton:function(t,n){var r;t.preventDefault(),r=e.one(v[this.currentedit.tool]),r.removeClass("assignfeedback_editpdf_selectedbutton"),r.setAttribute("aria-pressed","false"),this.currentedit.tool=n,this.refresh_button_state()},setup_save_cancel:function(){var t;t=e.one(f.SAVE),t.on("mousedown",this.handle_save,this),t.on("key",this.handle_save,"down:13",this),t.removeAttribute("disabled")},handle_cancel:function(e){e.preventDefault(),this.dialogue.hide()},stringify_current_page:function(){var t=[],n=[],r,i=0;for(i=0;i<this.pages[this.currentpage].comments.length;i++)t[i]=this.clean_comment_data(this.pages[this.currentpage].comments[i]);for(i=0;i<this.pages[this.currentpage].annotations.length;i++)n[i]=
this.clean_annotation_data(this.pages[this.currentpage].annotations[i]);return r={comments:t,annotations:n},e.JSON.stringify(r)},handle_save:function(t){t.preventDefault();var n=u,r;r={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"generatepdf",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(t,n){var r,i,s,o;try{r=e.JSON.parse(n.responseText);if(r.error)return new M.core.ajaxException(r);r.url&&(i=e.one("#"+this.get("downloadlinkid")),o=e.one("#"+this.get("downloadlinkid")+" span"),s=e.one("#"+this.get("deletelinkid")),o.setHTML(r.filename),i.setAttribute("href",r.url),i.removeClass("hidden"),s.removeClass("hidden")),this.dialogue.hide()}catch(u){return new M.core.exception(u)}},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(n,r)},edit_start:function(t){var n=e.one(f.DRAWINGCANVAS).getXY(),r=document.body.scrollTop,i=document.body.scrollLeft,s={x:t.clientX-n[0]+i,y:t.clientY-n[1]+r};if(this.currentedit.starttime)return;this.currentedit.starttime=(new Date).getTime(),this.currentedit.start=s,this.currentedit.end={x:s.x,y:s.y},this.currentannotation&&(this.currentedit.annotationstart={x:this.currentannotation.x,y:this.currentannotation.y}),this.currentedit.tool==="stamp"&&this.redraw_current_edit()},get_current_drawable:function(){var t=new M.assignfeedback_editpdf.drawable(this),n,r,i,s,o,u,a;if(!this.currentedit.start||!this.currentedit.end)return!1;this.currentedit.tool==="pen"&&(n=this.graphic.addShape({type:e.Path,fill:!1,stroke:{weight:m,color:p[this.currentedit.annotationcolour]}}),a=!0,e.each(this.currentedit.path,function(e){a?(n.moveTo(e.x,e.y),a=!1):n.lineTo(e.x,e.y)},this),n.end()),s=this.currentedit.start.x,this.currentedit.end.x>s?r=this.currentedit.end.x-s:(s=this.currentedit.end.x,r=this.currentedit.start.x-s),o=this.currentedit.start.y,this.currentedit.end.y>o?i=this.currentedit.end.y-o:(o=this.currentedit.end.y,i=this.currentedit.start.y-o);if(this.currentedit.tool==="stamp")return this.currentstampnodeid=Math.random()*1e16+1,stampnode=e.Node.create('<div id="'+this.currentstampnodeid+'" class="stamp" style="background-image:url(\''+this.stamps[this.currentstamp].url+"')\"/>"),e.one(".drawingcanvas").append(stampnode),stampnode.setStyles({position:"absolute",left:this.currentedit.end.x,top:this.currentedit.end.y,height:this.stamps[this.currentstamp].height,width:this.stamps[this.currentstamp].width}),t.nodes.push(stampnode),t;this.currentedit.tool==="comment"&&(n=this.graphic.addShape({type:e.Rect,width:r,height:i,fill:{color:h[this.currentedit.commentcolour]},x:s,y:o})),this.currentedit.tool==="line"&&(n=this.graphic.addShape({type:e.Path,fill:!1,stroke:{weight:m,color:p[this.currentedit.annotationcolour]}}),n.moveTo(this.currentedit.start.x,this.currentedit.start.y),n.lineTo(this.currentedit.end.x,this.currentedit.end.y),n.end());if(this.currentedit.tool==="rectangle"||this.currentedit.tool==="oval")this.currentedit.tool==="rectangle"&&(tooltype=e.Rect),this.currentedit.tool==="oval"&&(tooltype=e.Ellipse),n=this.graphic.addShape({type:tooltype,width:r,height:i,stroke:{weight:m,color:p[this.currentedit.annotationcolour]},x:s,y:o});return this.currentedit.tool==="highlight"&&(u=p[this.currentedit.annotationcolour],u=u.replace("rgb","rgba"),u=u.replace(")",",0.5)"),n=this.graphic.addShape({type:e.Rect,width:r,height:16,stroke:!1,fill:{color:u},x:s,y:this.currentedit.start.y})),t.shapes.push(n),t},redraw_current_edit:function(){this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=this.get_current_drawable()},move_annotation:function(t,n,r){var i=n-t.x,s=r-t.y,o,u,a;t.x+=i,t.y+=s,t.endx+=i,t.endy+=s,t.path&&(o=[],u=t.path.split(":"),e.each(u,function(e){a=e.split(","),o.push(parseInt(a[0],10)+i+","+(parseInt(a[1],10)+s))}),t.path=o.join(":")),t.drawable.erase(),this.drawables.push(this.draw_annotation(t))},edit_move:function(t){var n=e.one(f.DRAWINGCANVAS),r=parseInt(n.getStyle("width"),10),i=parseInt(n.getStyle("height"),10),s=n.getXY(),o=document.body.scrollTop,u=document.body.scrollLeft,a={x:t.clientX-s[0]+u,y:t.clientY-s[1]+o};if(a.x<0||a.x>r||a.y<0||a.y>i)return;this.currentedit.tool==="pen"&&this.currentedit.path.push(a),this.currentedit.tool==="select"?this.currentannotation&&this.currentedit&&this.move_annotation(this.currentannotation,this.currentedit.annotationstart.x+a.x-this.currentedit.start.x,this.currentedit.annotationstart.y+a.y-this.currentedit.start.y):this.currentedit.start&&(this.currentedit.end=a,this.redraw_current_edit())},clean_comment_data:function(e){return{gradeid:e.gradeid,x:e.x,y:e.y,width:e.width,rawtext:e.rawtext,pageno:e.currentpage,colour:e.colour}},clean_annotation_data:function(e){return{gradeid:e.gradeid,x:e.x,y:e.y,endx:e.endx,endy:e.endy,type:e.type,path:e.path,pageno:e.pageno,colour:e.colour}},edit_end:function(){var t,n,r,i,s,o,u,a=!1;o=(new Date).getTime()-this.currentedit.start;if(o<d||this.currentedit.start===!1)return;if(this.currentedit.tool==="comment")i=this.currentedit.start.x,this.currentedit.end.x>i?n=this.currentedit.end.x-i:(i=this.currentedit.end.x,n=this.currentedit.start.x-i),s=this.currentedit.start.y,this.currentedit.end.y>s?r=this.currentedit.end.y-s:(s=this.currentedit.end.y,r=this.currentedit.start.y-s),n<100&&(n=100),t={gradeid:this.get("gradeid"),x:i,y:s,width:n,rawtext:"",pageno:this.currentpage,colour:this.currentedit.commentcolour},this.pages[this.currentpage].comments.push(t),this.drawables.push(this.draw_comment(t,!0));else if(this.currentedit.tool==="pen"){u="";var f=null,l=null,c=null,h=null;e.each(this.currentedit.path,function(e){u=u+e.x+","+e.y+":",f===null?(f=c=e.x,l=h=e.y):(e.x<f&&(f=e.x),e.y<l&&(l=e.y),e.x>c&&(c=e.x),e.y>h&&(h=e.y))},this),u=u.substring(0,u.length-1),t={gradeid:this.get("gradeid"),path:u,type:"pen",pageno:this.currentpage,colour:this.currentedit.annotationcolour,x:f,y:l,endx:c,endy:h},this.pages[this.currentpage].annotations.push(t),this.drawables
.push(this.draw_annotation(t)),this.currentedit.path=[]}else this.currentedit.tool==="highlight"?(i=this.currentedit.start.x,this.currentedit.end.x>i?n=this.currentedit.end.x-i:(i=this.currentedit.end.x,n=this.currentedit.start.x-i),s=this.currentedit.start.y,r=16,t={gradeid:this.get("gradeid"),x:i,y:s,endx:i+n,endy:s+r,type:this.currentedit.tool,pageno:this.currentpage,colour:this.currentedit.annotationcolour},this.pages[this.currentpage].annotations.push(t),this.drawables.push(this.draw_annotation(t))):this.currentedit.tool==="select"?(i=this.currentedit.end.x,s=this.currentedit.end.y,annotations=this.pages[this.currentpage].annotations,e.each(annotations,function(e){(i-e.x)*(i-e.endx)<=0&&(s-e.y)*(s-e.endy)<=0&&(a=e)}),a&&(this.currentannotation=a),this.redraw()):this.currentedit.tool==="stamp"?(t={gradeid:this.get("gradeid"),x:this.currentedit.start.x,y:this.currentedit.start.y,endx:this.currentedit.end.x,endy:this.currentedit.end.y,type:this.currentedit.tool,pageno:this.currentpage,colour:this.currentedit.annotationcolour,path:this.stamps[this.currentstamp].url.replace(/^.*[\\\/]/,"")},this.pages[this.currentpage].annotations.push(t),this.drawables.push(this.draw_annotation(t))):(t={gradeid:this.get("gradeid"),x:this.currentedit.start.x,y:this.currentedit.start.y,endx:this.currentedit.end.x,endy:this.currentedit.end.y,type:this.currentedit.tool,pageno:this.currentpage,colour:this.currentedit.annotationcolour},this.pages[this.currentpage].annotations.push(t),this.drawables.push(this.draw_annotation(t)));this.save_current_page(),this.currentedit.starttime=0,this.currentedit.start=!1,this.currentedit.end=!1,this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=!1},save_current_page:function(){var t=u,n;n={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"savepage",index:this.currentpage,userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),page:this.stringify_current_page()},on:{success:function(t,n){var r;try{r=e.JSON.parse(n.responseText);if(r.error)return new M.core.ajaxException(r)}catch(i){return new M.core.exception(i)}},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(t,n)},delete_annotation:function(e){var t=e.target,n=t.getData("annotation"),r;n||(t=t.ancestor(),n=t.getData("annotation")),r=this.pages[this.currentpage].annotations;for(i=0;i<r.length;i++)if(r[i]===n){r.splice(i,1),n.drawable.erase(),this.save_current_page();return}},draw_annotation:function(t){var n,r,i,s,o,u,a,h,d=e.one(f.DRAWINGREGION),v=e.one(f.DRAWINGCANVAS).getXY(),g,y;n=new M.assignfeedback_editpdf.drawable(this);if(t.type==="stamp")return e.each(this.stamps,function(r){if(t.path===r.url.replace(/^.*[\\\/]/,"")){this.currentstampnodeid=Math.random()*1e16+1,stampnode=e.Node.create('<div id="'+this.currentstampnodeid+'" class="stamp" style="background-image:url(\''+r.url+"')\"/>"),e.one(".drawingcanvas").append(stampnode),stampnode.setStyles({position:"absolute",left:t.endx,top:t.endy,height:r.height,width:r.width});var i=new Image;i.src=r.url,i.stampnode=stampnode,i.onload=function(){this.stampnode.setStyles({height:this.height,width:this.width})},n.nodes.push(stampnode)}},this),n;t.type==="line"&&(g=this.graphic.addShape({type:e.Path,fill:!1,stroke:{weight:m,color:p[t.colour]}}),g.moveTo(t.x,t.y),g.lineTo(t.endx,t.endy),g.end()),t.type==="pen"&&(g=this.graphic.addShape({type:e.Path,fill:!1,stroke:{weight:m,color:p[t.colour]}}),y=!0,r=t.path.split(":"),e.each(r,function(e){i=e.split(","),y?(g.moveTo(i[0],i[1]),y=!1):g.lineTo(i[0],i[1])},this),g.end());if(t.type==="rectangle"||t.type==="oval")t.type==="rectangle"&&(h=e.Rect),t.type==="oval"&&(h=e.Ellipse),t.x=parseInt(t.x,10),t.y=parseInt(t.y,10),t.endx=parseInt(t.endx,10),t.endy=parseInt(t.endy,10),u=t.x,t.endx>u?s=t.endx-u:(u=t.endx,s=t.x-u),a=t.y,t.endy>a?o=t.endy-a:(a=t.endy,o=t.y-a),g=this.graphic.addShape({type:h,width:s,height:o,stroke:{weight:m,color:p[t.colour]},x:u,y:a});t.type==="highlight"&&(t.x=parseInt(t.x,10),t.y=parseInt(t.y,10),t.endx=parseInt(t.endx,10),t.endy=parseInt(t.endy,10),u=t.x,t.endx>u?s=t.endx-u:(u=t.endx,s=t.x-u),a=t.y,t.endy>a?o=t.endy-a:(a=t.endy,o=t.y-a),highlightcolour=p[t.colour],highlightcolour=highlightcolour.replace("rgb","rgba"),highlightcolour=highlightcolour.replace(")",",0.5)"),g=this.graphic.addShape({type:e.Rect,width:s,height:o,stroke:!1,fill:{color:highlightcolour},x:u,y:a}));if(!g)return n;n.shapes.push(g);if(this.currentannotation===t){t.x=parseInt(t.x,10),t.y=parseInt(t.y,10),t.endx=parseInt(t.endx,10),t.endy=parseInt(t.endy,10),u=t.x,t.endx>u?s=t.endx-u:(u=t.endx,s=t.x-u),a=t.y,t.endy>a?o=t.endy-a:(a=t.endy,o=t.y-a),g=this.graphic.addShape({type:e.Rect,width:s,height:o,stroke:{weight:m,color:l},fill:{color:c},x:u,y:a}),n.shapes.push(g);var b=e.Node.create('<img src="'+M.util.image_url("trash","assignfeedback_editpdf")+'"/>'),w=e.Node.create('<a href="#" role="button"></a>');b.setAttrs({alt:M.util.get_string("deleteannotation","assignfeedback_editpdf")}),b.setStyles({backgroundColor:"white",border:"2px solid "+l}),w.addClass("deleteannotationbutton"),w.append(b),d.append(w),w.setData("annotation",t),w.setStyle("zIndex","1000"),w.on("click",this.delete_annotation,this),w.on("key",this.delete_annotation,"space,enter",this),w.setX(v[0]+u+s-20),w.setY(v[1]+a+2),n.nodes.push(w)}return t.drawable=n,n},delete_comment:function(e){var t=0,n;n=this.pages[this.currentpage].comments;for(t=0;t<n.length;t++)if(n[t]===e){n.splice(t,1),e.drawable.erase(),this.save_current_page();return}},draw_comment:function(t,n){var r=new M.assignfeedback_editpdf.drawable(this),i,s=e.one(f.DRAWINGREGION),o=e.one(f.DRAWINGCANVAS).getXY(),u=e.one(f.DIALOGUE).getXY(),a=o[0]-u[0],l=o[1]-u[1],c,p;return i=e.Node.create("<textarea/>"),c=e.Node.create('<div class="commentdrawable"/>'),p=e.Node.create('<a href="#"><img src="'+this.get("menuicon")+'"/></a>'),c.append(i),c.append(p),t.width<100&&(t.width=100),c.setStyles({position:"absolute",left
:parseInt(t.x,10)+a+"px",top:parseInt(t.y,10)+l+"px"}),i.setStyles({width:t.width+"px",backgroundColor:h[t.colour]}),s.append(c),r.nodes.push(c),i.set("value",t.rawtext),i.setStyle("height",i.get("scrollHeight")-8+"px"),this.attach_comment_events(t,i,p),n&&i.focus(),t.drawable=r,r},load_quicklist:function(){var t=u,n;n={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"loadquicklist",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(t,n){var r;try{r=e.JSON.parse(n.responseText);if(r.error)return new M.core.ajaxException(r);this.quicklist=[],e.each(r,function(e){this.quicklist.push(e)},this)}catch(i){return new M.core.exception(i)}},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(t,n)},add_to_quicklist:function(){var t=u,n;this.commentmenu.hide();if(this.currentcomment.rawtext==="")return;n={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"addtoquicklist",userid:this.get("userid"),commenttext:this.currentcomment.rawtext,width:this.currentcomment.width,colour:this.currentcomment.colour,attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(t,n){var r;try{r=e.JSON.parse(n.responseText);if(r.error)return new M.core.ajaxException(r);this.quicklist.push(r)}catch(i){return new M.core.exception(i)}},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(t,n)},remove_from_quicklist:function(t){var n=t.target,r=n.getData("comment"),i=u,s;this.commentmenu.hide(),r||(n=n.ancestor(),r=n.getData("comment"));if(!r)return;s={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"removefromquicklist",userid:this.get("userid"),commentid:r.id,attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(){var e;e=this.quicklist.indexOf(r),e>=0&&this.quicklist.splice(e,1)},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(i,s)},set_comment_from_quick_comment:function(e){var t=e.target,n=t.getData("comment");this.commentmenu.hide(),n||(t=t.ancestor(),n=t.getData("comment"));if(!n||!this.currentcomment)return;this.currentcomment.rawtext=n.rawtext,this.currentcomment.width=n.width,this.currentcomment.colour=n.colour,this.save_current_page(),this.redraw()},filter_search_comments:function(){var t,n,r;t=e.one(f.SEARCHFILTER),n=e.one(f.SEARCHCOMMENTSLIST),r=t.get("value"),n.all("li").each(function(e){e.get("text").indexOf(r)!==-1?e.show():e.hide()})},focus_on_comment:function(e){var t=e.target.ancestor("li"),n=t.getData("comment");this.searchcommentswindow.hide(),n.pageno===this.currentpage?n.drawable.nodes[0].one("textarea").focus():(this.currentpage=n.pageno,this.change_page(),n.drawable.nodes[0].one("textarea").focus())},open_search_comments:function(t){var n,r,i,s;this.searchcommentswindow?(n=this.searchcommentswindow.get("boundingBox").one("ul"),n.all("li").remove(!0)):(i=e.Node.create("<div/>"),s=M.util.get_string("filter","assignfeedback_editpdf"),r=e.Node.create('<input type="text" size="20" placeholder="'+s+'"/>'),i.append(r),n=e.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),i.append(n),this.searchcommentswindow=new M.core.dialogue({extraClasses:["assignfeedback_editpdf_searchcomments"],draggable:!1,centered:!0,lightbox:!0,width:"400px",visible:!1,zIndex:100,headerContent:M.util.get_string("searchcomments","assignfeedback_editpdf"),bodyContent:i,footerContent:""}),r.on("keyup",this.filter_search_comments,null,this),n.delegate("click",this.focus_on_comment,"a",this),n.delegate("key",this.focus_on_comment,"enter,space","a",this)),e.each(this.pages,function(t){e.each(t.comments,function(t){var r=e.Node.create('<li><a href="#" tabindex="-1"><pre>'+t.rawtext+"</pre></a></li>");n.append(r),r.setData("comment",t)},this)},this),this.searchcommentswindow.centerDialogue(),this.searchcommentswindow.show(),t.preventDefault()},open_comment_menu:function(t){var n=t.target,r=t.target.getData("comment"),i,s;this.commenttodelete=null,r||(n=n.ancestor(),r=n.getData("comment")),this.currentcomment=r,this.currentcommentmenulink=n,this.commentmenu?(this.commentmenu.align(n,[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]),i=this.commentmenu.get("boundingBox").one("ul"),i.all(".quicklist_comment").remove(!0)):(i=e.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),s=e.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("addtoquicklist","assignfeedback_editpdf")+"</a></li>"),s.on("click",this.add_to_quicklist,this),s.on("key",this.add_to_quicklist,"enter,space",this),i.append(s),s=e.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("deletecomment","assignfeedback_editpdf")+"</a></li>"),s.on("click",function(){this.commentmenu.hide(),this.delete_comment(this.currentcomment)},this),s.on("key",function(){this.commentmenu.hide(),this.delete_comment(this.currentcomment)},"enter,space",this),i.append(s),s=e.Node.create("<li><hr/></li>"),i.append(s),this.commentmenu=new M.core.dialogue({extraClasses:["assignfeedback_editpdf_commentmenu"],draggable:!1,centered:!1,lightbox:!1,width:"auto",visible:!1,zIndex:100,bodyContent:i,footerContent:"",align:{node:n,points:[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]}}),i.on("clickoutside",function(e){e.target!==this.currentcommentmenulink&&e.target.ancestor()!==this.currentcommentmenulink&&(e.preventDefault(),this.commentmenu.hide())},this)),e.each(this.quicklist,function(t){var n=e.Node.create('<li class="quicklist_comment"></li>'),r=e.Node.create('<a href="#" tabindex="-1">'+t.rawtext+"</a>"),s=e.Node.create('<a href="#" tabindex="-1" class="delete_quicklist_comment"><img src="'+M.util.image_url("t/delete","core")+'" '+'alt="'+M.util.get_string("deletecomment","assignfeedback_editpdf")+'"/>'+"</a>");n.append(r),n.append(s),n.setData("comment",t),i.append(n),r.on("click",this.set_comment_from_quick_comment,this),r.on("key",this.set_comment_from_quick_comment
,"space,enter",this),s.setData("comment",t),s.on("click",this.remove_from_quicklist,this),s.on("key",this.remove_from_quicklist,"space,enter",this)},this),this.commentmenu.show()},delete_comment_later:function(){this.commenttodelete!==null&&this.delete_comment(this.commenttodelete)},attach_comment_events:function(t,n,r){n.on("blur",function(){t.rawtext=n.get("value"),t.width=parseInt(n.getStyle("width"),10),t.rawtext.replace(/^\s+|\s+$/g,"")===""&&(this.commenttodelete=t,e.later(400,this,this.delete_comment_later)),this.save_current_page()},this),r.setData("comment",t),n.on("keyup",function(){var e=n.get("scrollHeight")-8;this.setStyle("height",e+"px")}),n.on("gesturemovestart",function(e){n.setData("dragging",!0),n.setData("offsetx",e.clientX-n.getX()),n.setData("offsety",e.clientY-n.getY())}),n.on("gesturemoveend",function(){n.setData("dragging",!1),this.save_current_page()},null,this),n.on("gesturemove",function(r){var i=r.clientX-n.getData("offsetx"),s=r.clientY-n.getData("offsety"),o=e.one(f.DRAWINGCANVAS),u=o.getXY(),a,l,c,h,p=u[0],d=u[1];a=parseInt(o.getStyle("width"),10),l=parseInt(o.getStyle("height"),10),c=parseInt(n.getStyle("width"),10),h=parseInt(n.getStyle("height"),10),i<p&&(i=p),s<d&&(s=d),i-p+c>a&&(i=p+a-c),s-d+h>l&&(s=d+l-h),t.x=i-p,t.y=s-d,n.ancestor().setX(i),n.ancestor().setY(s)})},redraw:function(){var e,t;t=this.pages[this.currentpage];while(this.drawables.length>0)this.drawables.pop().erase();for(e=0;e<t.annotations.length;e++)this.drawables.push(this.draw_annotation(t.annotations[e]));for(e=0;e<t.comments.length;e++)this.drawables.push(this.draw_comment(t.comments[e],!1))},change_page:function(){var t=e.one(f.DRAWINGCANVAS),n,r,i;r=e.one(f.PREVIOUSBUTTON),i=e.one(f.NEXTBUTTON),this.currentpage>0?r.removeAttribute("disabled"):r.setAttribute("disabled","true"),this.currentpage<this.pagecount-1?i.removeAttribute("disabled"):i.setAttribute("disabled","true"),n=this.pages[this.currentpage],this.loadingicon.hide(),t.setStyle("backgroundImage",'url("'+n.url+'")'),this.redraw()},setup_navigation:function(){var t,n,r,i,s;t=e.one(f.PAGESELECT),options=t.all("option");if(options.size()<=1)for(n=0;n<this.pages.length;n++)r=e.Node.create("<option/>"),r.setAttribute("value",n),r.setHTML(n+1),t.append(r);t.removeAttribute("disabled"),t.on("change",function(){this.currentpage=t.get("value"),this.change_page()},this),i=e.one(f.PREVIOUSBUTTON),s=e.one(f.NEXTBUTTON),i.on("click",this.previous_page,this),i.on("key",this.previous_page,"down:13",this),s.on("click",this.next_page,this),s.on("key",this.next_page,"down:13",this)},previous_page:function(){this.currentpage--,this.currentpage<0&&(this.currentpage=0),this.change_page()},next_page:function(){this.currentpage++,this.currentpage>=this.pages.length&&(this.currentpage=this.pages.length-1),this.change_page()}},e.extend(EDITOR,e.Base,EDITOR.prototype,{NAME:"moodle-assignfeedback_editpdf-editor",ATTRS:{userid:{validator:e.Lang.isInteger,value:0},assignmentid:{validator:e.Lang.isInteger,value:0},attemptnumber:{validator:e.Lang.isInteger,value:0},header:{validator:e.Lang.isString,value:""},body:{validator:e.Lang.isString,value:""},footer:{validator:e.Lang.isString,value:""},linkid:{validator:e.Lang.isString,value:""},deletelinkid:{validator:e.Lang.isString,value:""},downloadlinkid:{validator:e.Lang.isString,value:""},menuicon:{validator:e.Lang.isString,value:""},stampfileurls:{validator:e.Lang.isArray,value:""}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.editor=M.assignfeedback_editpdf.editor||{},M.assignfeedback_editpdf.editor.init=M.assignfeedback_editpdf.editor.init||function(e){return new EDITOR(e)}},"@VERSION@",{requires:["base","event","node","io","graphics","json","event-move","querystring-stringify-simple","moodle-core-notification-dialog","moodle-core-notification-exception","moodle-core-notification-ajaxexception"]});
