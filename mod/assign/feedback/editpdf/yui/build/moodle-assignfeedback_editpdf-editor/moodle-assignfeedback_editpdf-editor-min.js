YUI.add("moodle-assignfeedback_editpdf-editor",function(e,t){var n=M.cfg.wwwroot+"/mod/assign/feedback/editpdf/ajax.php",r={DIALOGUE:"assignfeedback_editpdf_widget"},s={PREVIOUSBUTTON:"."+r.DIALOGUE+" .navigate-previous-button",NEXTBUTTON:"."+r.DIALOGUE+" .navigate-next-button",SEARCHCOMMENTSBUTTON:"."+r.DIALOGUE+" .searchcommentsbutton",SEARCHFILTER:".assignfeedback_editpdf_searchcomments input",SEARCHCOMMENTSLIST:".assignfeedback_editpdf_searchcomments ul",PAGESELECT:"."+r.DIALOGUE+" .navigate-page-select",LOADINGICON:"."+r.DIALOGUE+" .loading",DRAWINGREGION:"."+r.DIALOGUE+" .drawingregion",DRAWINGCANVAS:"."+r.DIALOGUE+" .drawingcanvas",SAVE:"."+r.DIALOGUE+" .savebutton",COMMENTCOLOURBUTTON:"."+r.DIALOGUE+" .commentcolourbutton",COMMENTMENU:" .commentdrawable a",ANNOTATIONCOLOURBUTTON:"."+r.DIALOGUE+" .annotationcolourbutton",DELETEANNOTATIONBUTTON:"."+r.DIALOGUE+" .deleteannotationbutton",STAMPSBUTTON:"."+r.DIALOGUE+" .currentstampbutton",DIALOGUE:"."+r.DIALOGUE},o="rgba(200, 200, 255, 0.9)",u="rgba(200, 200, 255, 0.5)",a={white:"rgb(255,255,255)",yellow:"rgb(255,255,176)",red:"rgb(255,176,176)",green:"rgb(176,255,176)",blue:"rgb(208,208,255)",clear:"rgba(255,255,255, 0)"},f={white:"rgb(255,255,255)",yellow:"rgb(255,255,0)",red:"rgb(255,0,0)",green:"rgb(0,255,0)",blue:"rgb(0,0,255)",black:"rgb(0,0,0)"},l=300,c={comment:"."+r.DIALOGUE+" .commentbutton",pen:"."+r.DIALOGUE+" .penbutton",line:"."+r.DIALOGUE+" .linebutton",rectangle:"."+r.DIALOGUE+" .rectanglebutton",oval:"."+r.DIALOGUE+" .ovalbutton",stamp:"."+r.DIALOGUE+" .stampbutton",select:"."+r.DIALOGUE+" .selectbutton",highlight:"."+r.DIALOGUE+" .highlightbutton"},h=4;POINT=function(e,t){this.x=parseInt(e,10),this.y=parseInt(t,10),this.clip=function(e){return this.x<e.x&&(this.x=e.x),this.x>e.x+e.width&&(this.x=e.x+e.width),this.y<e.y&&(this.y=e.y),this.y>e.y+e.height&&(this.y=e.y+e.height),this}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.point=POINT,RECT=function(e,t,n,r){this.x=e,this.y=t,this.width=n,this.height=r,this.bound=function(e){var t=0,n=0,r=0,i=0,s=0,o;for(s=0;s<e.length;s++){o=e[s];if(o.x<t||s===0)t=o.x;if(o.x>n||s===0)n=o.x;if(o.y<r||s===0)r=o.y;if(o.y>i||s===0)i=o.y}return this.x=t,this.y=r,this.width=n-t,this.height=i-r,this}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.rect=RECT,EDIT=function(){this.start=!1,this.end=!1,this.starttime=0,this.annotationstart=!1,this.tool="comment",this.commentcolour="yellow",this.annotationcolour="red",this.path=[]},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.edit=EDIT,DRAWABLE=function(e){this.editor=e,this.shapes=[],this.nodes=[],this.erase=function(){if(this.shapes)while(this.shapes.length>0)this.editor.graphic.removeShape(this.shapes.pop());if(this.nodes)while(this.nodes.length>0)this.nodes.pop().remove()}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.drawable=DRAWABLE,ANNOTATION=function(t,n,r,a,l,c,p,d,v,m){this.editor=t,this.gradeid=parseInt(n,10)||0,this.pageno=parseInt(r,10)||0,this.x=parseInt(a,10)||0,this.y=parseInt(l,10)||0,this.endx=parseInt(c,10)||0,this.endy=parseInt(p,10)||0,this.path=m||"",this.type=d||"rect",this.colour=v||"red",this.drawable=!1,this.clean=function(){return{gradeid:this.gradeid,x:this.x,y:this.y,endx:this.endx,endy:this.endy,type:this.type,path:this.path,pageno:this.pageno,colour:this.colour}},this.draw=function(){var t,n,r,i,a,l=e.one(s.DRAWINGREGION),c=e.one(s.DRAWINGCANVAS).getXY(),p,d;t=new M.assignfeedback_editpdf.drawable(this.editor),this.type==="stamp"&&e.each(this.editor.stamps,function(n){this.path===n.url.replace(/^.*[\\\/]/,"")&&(stampnode=e.Node.create('<div class="stamp" style="background-image:url(\''+n.url+"')\"/>"),e.one(".drawingcanvas").append(stampnode),stampnode.setStyles({height:n.height,width:n.width}),stampnode.setXY([this.x,this.y]),t.nodes.push(stampnode))},this),this.type==="line"&&(p=this.editor.graphic.addShape({type:e.Path,fill:!1,stroke:{weight:h,color:f[this.colour]}}),p.moveTo(this.x,this.y),p.lineTo(this.endx,this.endy),p.end()),this.type==="pen"&&(p=this.editor.graphic.addShape({type:e.Path,fill:!1,stroke:{weight:h,color:f[this.colour]}}),d=!0,n=this.path.split(":"),e.each(n,function(e){r=e.split(","),d?(p.moveTo(r[0],r[1]),d=!1):p.lineTo(r[0],r[1])},this),p.end());if(this.type==="rectangle"||this.type==="oval")this.type==="rectangle"&&(a=e.Rect),this.type==="oval"&&(a=e.Ellipse),i=new M.assignfeedback_editpdf.rect,i.bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),p=this.editor.graphic.addShape({type:a,width:i.width,height:i.height,stroke:{weight:h,color:f[this.colour]},x:i.x,y:i.y});this.type==="highlight"&&(i=new M.assignfeedback_editpdf.rect,i.bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),highlightcolour=f[this.colour],highlightcolour=highlightcolour.replace("rgb","rgba"),highlightcolour=highlightcolour.replace(")",",0.5)"),p=this.editor.graphic.addShape({type:e.Rect,width:i.width,height:i.height,stroke:!1,fill:{color:highlightcolour},x:i.x,y:i.y})),t.shapes.push(p);if(this.editor.currentannotation===this){i=new M.assignfeedback_editpdf.rect,i.bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),p=this.editor.graphic.addShape({type:e.Rect,width:i.width,height:i.height,stroke:{weight:h,color:o},fill:{color:u},x:i.x,y:i.y}),t.shapes.push(p);var v=e.Node.create('<img src="'+M.util.image_url("trash","assignfeedback_editpdf")+'"/>'),m=e.Node.create('<a href="#" role="button"></a>');v.setAttrs({alt:M.util.get_string("deleteannotation","assignfeedback_editpdf")}),v.setStyles({backgroundColor:"white",border:"2px solid "+o}),m.addClass("deleteannotationbutton"),m.append(v),l.append(m),m.setData("annotation",this),m.setStyle("zIndex","200"),m.on("click",this.remove,this),m.on("key",this.remove
,"space,enter",this),m.setX(c[0]+i.x+i.width-20),m.setY(c[1]+i.y+4),t.nodes.push(m)}return this.drawable=t,t},this.remove=function(){var e;e=this.editor.pages[this.editor.currentpage].annotations;for(i=0;i<e.length;i++)if(e[i]===this){e.splice(i,1),this.drawable.erase(),this.editor.save_current_page();return}},this.move=function(t,n){var r=t-this.x,i=n-this.y,s,o,u,a,f;this.x+=r,this.y+=i,this.endx+=r,this.endy+=i,this.path&&(s=[],o=this.path.split(":"),e.each(o,function(e){u=e.split(","),a=parseInt(u[0],10),f=parseInt(u[1],10),s.push(a+r+","+(f+i))}),this.path=s.join(":")),this.drawable.erase(),this.editor.drawables.push(this.draw())}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotation=ANNOTATION;var p="Dropdown menu",d;d=function(e){e.draggable=!1,e.centered=!1,e.width="auto",e.lightbox=!1,e.visible=!1,e.zIndex=100,e.footerContent="",d.superclass.constructor.apply(this,[e])},e.extend(d,M.core.dialogue,{initializer:function(t){var n,r,i,s;d.superclass.initializer.call(this,t),s=this.get("boundingBox"),s.addClass("assignfeedback_editpdf_dropdown"),n=this.get("buttonNode"),r=this.bodyNode,i=e.Node.create("<h3/>"),i.addClass("accesshide"),i.setHTML(this.get("headerText")),r.prepend(i),r.on("clickoutside",function(e){e.target!==n&&e.target.ancestor()!==n&&(e.preventDefault(),this.hide())},this),n.on("click",this.show,this),n.on("key",this.show,"enter,space",this)},show:function(){var t=this.get("buttonNode");result=d.superclass.show.call(this),this.align(t,[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL])}},{NAME:p,ATTRS:{headerText:{value:""},buttonNode:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.dropdown=d;var v="Colourpicker",m;m=function(e){m.superclass.constructor.apply(this,[e])},e.extend(m,M.assignfeedback_editpdf.dropdown,{initializer:function(t){var n=e.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),r;e.each(this.get("colours"),function(t,r){var i,s,o,u;o=M.util.get_string(r,"assignfeedback_editpdf"),u=M.util.image_url("commentcolour","assignfeedback_editpdf"),i=e.Node.create('<button><img alt="'+o+'" src="'+u+'"/></button>'),i.setAttribute("data-colour",r),i.setAttribute("data-rgb",t),i.addClass("colour_"+r),i.setStyle("backgroundImage","none"),i.one("img").setStyle("background",t),r==="clear"&&i.one("img").setStyle("borderStyle","dashed"),s=e.Node.create("<li/>"),s.append(i),n.append(s)},this),r=e.Node.create("<div/>"),n.delegate("click",this.callback_handler,"button",this),n.delegate("key",this.callback_handler,"down:13","button",this),this.set("headerText",M.util.get_string("colourpicker","assignfeedback_editpdf")),r.append(n),this.set("bodyContent",r),m.superclass.initializer.call(this,t)},callback_handler:function(t){var n=this.get("callback"),r=this.get("context"),i;this.hide(),i=e.bind(n,r,t),i()}},{NAME:v,ATTRS:{colours:{value:{}},callback:{value:null},context:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.colourpicker=m;var g="Commentmenu",y;y=function(e){y.superclass.constructor.apply(this,[e])},e.extend(y,M.assignfeedback_editpdf.dropdown,{initializer:function(t){var n,r,i,s;s=this.get("comment"),n=e.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),r=e.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("addtoquicklist","assignfeedback_editpdf")+"</a></li>"),r.on("click",s.add_to_quicklist,s),r.on("key",s.add_to_quicklist,"enter,space",s),n.append(r),r=e.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("deletecomment","assignfeedback_editpdf")+"</a></li>"),r.on("click",function(){s.menu.hide(),s.remove()},s),r.on("key",function(){s.menu.hide(),s.remove()},"enter,space",s),n.append(r),r=e.Node.create("<li><hr/></li>"),n.append(r),this.set("headerText",M.util.get_string("commentcontextmenu","assignfeedback_editpdf")),i=e.Node.create("<div/>"),i.append(n),this.set("bodyContent",i),y.superclass.initializer.call(this,t)},show:function(){var t=this.get("boundingBox").one("ul");t.all(".quicklist_comment").remove(!0),comment=this.get("comment"),e.each(comment.editor.quicklist.comments,function(n){var r=e.Node.create('<li class="quicklist_comment"></li>'),i=e.Node.create('<a href="#" tabindex="-1">'+n.rawtext+"</a>"),s=e.Node.create('<a href="#" tabindex="-1" class="delete_quicklist_comment"><img src="'+M.util.image_url("t/delete","core")+'" '+'alt="'+M.util.get_string("deletecomment","assignfeedback_editpdf")+'"/>'+"</a>");r.append(i),r.append(s),t.append(r),i.on("click",comment.set_from_quick_comment,comment,n),i.on("key",comment.set_from_quick_comment,"space,enter",comment,n),s.on("click",comment.remove_from_quicklist,comment,n),s.on("key",comment.remove_from_quicklist,"space,enter",comment,n)},this),y.superclass.show.call(this)}},{NAME:g,ATTRS:{comment:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.commentmenu=y,COMMENT=function(t,n,r,i,o,u,f,l){this.editor=t,this.gradeid=n||0,this.x=parseInt(i,10)||0,this.y=parseInt(o,10)||0,this.width=parseInt(u,10)||0,this.rawtext=l||"",this.pageno=r||0,this.colour=f||"yellow",this.drawable=!1,this.deleteme=!1,this.menulink=null,this.menu=null,this.clean=function(){return{gradeid:this.gradeid,x:this.x,y:this.y,width:this.width,rawtext:this.rawtext,pageno:this.currentpage,colour:this.colour}},this.draw=function(t){var n=new M.assignfeedback_editpdf.drawable(this.editor),r,i=e.one(s.DRAWINGREGION),o,u,f;return r=e.Node.create("<textarea/>"),o=e.Node.create('<div class="commentdrawable"/>'),u=e.Node.create('<a href="#"><img src="'+this.editor.get("menuicon")+'"/></a>'),this.menulink=u,o.append(r),o.append(u),this.width<100&&(this.width=100),f=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x,this.y)),o.setStyles({position:"absolute",left:f.x+"px",top:f.y+"px"}),r.setStyles({width:this.width+"px",backgroundColor:a[this.colour]}),i.append(o),n.nodes.push(o),r.set("value"
,this.rawtext),r.setStyle("height",r.get("scrollHeight")-8+"px"),this.attach_events(r,u),t&&r.focus(),this.drawable=n,n},this.delete_comment_later=function(){this.deleteme&&this.remove()},this.attach_events=function(t,n){t.on("blur",function(){this.rawtext=t.get("value"),this.width=parseInt(t.getStyle("width"),10),this.rawtext.replace(/^\s+|\s+$/g,"")===""&&(this.deleteme=!0,e.later(400,this,this.delete_comment_later)),this.editor.save_current_page()},this),n.setData("comment",this),t.on("keyup",function(){var e=t.get("scrollHeight")-8;t.setStyle("height",e+"px")}),t.on("gesturemovestart",function(e){t.setData("dragging",!0),t.setData("offsetx",e.clientX-t.getX()),t.setData("offsety",e.clientY-t.getY())}),t.on("gesturemoveend",function(){t.setData("dragging",!1),this.editor.save_current_page()},null,this),t.on("gesturemove",function(e){var n=e.clientX-t.getData("offsetx"),r=e.clientY-t.getData("offsety"),i,s,o,u,a;i=parseInt(t.getStyle("width"),10),s=parseInt(t.getStyle("height"),10),o=this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(n,r),!0),a=this.editor.get_canvas_bounds(!0),a.x=0,a.y=0,a.width-=i+42,a.height-=s+8,o.clip(a),this.x=o.x,this.y=o.y,u=this.editor.get_window_coordinates(o,!0),t.ancestor().setX(u.x),t.ancestor().setY(u.y)},null,this),this.menu=new M.assignfeedback_editpdf.commentmenu({buttonNode:this.menulink,comment:this})},this.remove=function(){var e=0,t;t=this.editor.pages[this.editor.currentpage].comments;for(e=0;e<t.length;e++)if(t[e]===this){t.splice(e,1),this.drawable.erase(),this.editor.save_current_page();return}},this.remove_from_quicklist=function(e,t){this.menu.hide(),this.editor.quicklist.remove(t)},this.set_from_quick_comment=function(e,t){this.menu.hide(),this.rawtext=t.rawtext,this.width=t.width,this.colour=t.colour,this.editor.save_current_page(),this.editor.redraw()},this.add_to_quicklist=function(){this.menu.hide(),this.editor.quicklist.add(this)}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.comment=COMMENT,QUICKCOMMENT=function(e,t,n,r){this.rawtext=t||"",this.id=e||0,this.width=n||100,this.colour=r||"yellow"},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.quickcomment=QUICKCOMMENT,QUICKCOMMENTLIST=function(t){this.editor=t,this.comments=[],this.add=function(t){var r=n,i;if(t.rawtext==="")return;i={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"addtoquicklist",userid:this.editor.get("userid"),commenttext:t.rawtext,width:t.width,colour:t.colour,attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(t,n){var r,i;try{r=e.JSON.parse(n.responseText);if(r.error)return new M.core.ajaxException(r);i=new M.assignfeedback_editpdf.quickcomment(r.id,r.rawtext,r.width,r.colour),this.comments.push(i)}catch(s){return new M.core.exception(s)}},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(r,i)},this.remove=function(t){var r=n,i;if(!t)return;i={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"removefromquicklist",userid:this.editor.get("userid"),commentid:t.id,attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(){var e;e=this.comments.indexOf(t),e>=0&&this.comments.splice(e,1)},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(r,i)},this.load=function(){var t=n,r;r={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"loadquicklist",userid:this.editor.get("userid"),attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(t,n){var r;try{r=e.JSON.parse(n.responseText);if(r.error)return new M.core.ajaxException(r);e.each(r,function(e){var t=new M.assignfeedback_editpdf.quickcomment(e.id,e.rawtext,e.width,e.colour);this.comments.push(t)},this)}catch(i){return new M.core.exception(i)}},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(t,r)}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.quickcommentlist=QUICKCOMMENTLIST,Stamp=function(){this.url="",this.width=0,this.height=0},EDITOR=function(){EDITOR.superclass.constructor.apply(this,arguments)},EDITOR.prototype={dialogue:null,pagecount:0,currentpage:0,pages:[],loadingicon:null,pageimage:null,graphic:null,currentedit:new M.assignfeedback_editpdf.edit,currentdrawable:!1,drawables:[],currentcomment:null,currentannotation:null,quicklist:null,searchcommentswindow:null,currentstamp:null,stamps:[],currentstampnodeid:null,currentstamppicker:null,initializer:function(){var t,n;this.quicklist=new M.assignfeedback_editpdf.quickcommentlist(this),t=e.one("#"+this.get("linkid")),t.on("click",this.link_handler,this),t.on("key",this.link_handler,"down:13",this),n=e.one("#"+this.get("deletelinkid")),n.on("click",this.delete_link_handler,this),n.on("key",this.delete_link_handler,"down:13",this),this.currentedit.start=!1,this.currentedit.end=!1},refresh_button_state:function(){var t,n;t=e.one(s.COMMENTCOLOURBUTTON),t.setStyle("backgroundImage","none"),t.one("img").setStyle("background",a[this.currentedit.commentcolour]),this.currentedit.commentcolour==="clear"?t.one("img").setStyle("borderStyle","dashed"):t.one("img").setStyle("borderStyle","solid"),t=e.one(s.ANNOTATIONCOLOURBUTTON),t.setStyle("backgroundImage","none"),t.one("img").setStyle("backgroundColor",f[this.currentedit.annotationcolour]),n=e.one(c[this.currentedit.tool]),n.addClass("assignfeedback_editpdf_selectedbutton"),n.setAttribute("aria-pressed","true")},get_canvas_bounds:function(t){var n=e.one(s.DRAWINGCANVAS),r=n.getXY(),i=e.one(s.DIALOGUE).getXY(),o=r[0]-i[0],u=r[1]-i[1],a=parseInt(n.getStyle("width"),10),f=parseInt(n.getStyle("height"),10);return t&&(o+=i[0],u+=i[1]),new M.assignfeedback_editpdf.rect(o,u,a,f)},get_canvas_coordinates:function(e,t){var n=this.get_canvas_bounds(t),r=new M.assignfeedback_editpdf.point(e.x-n.x,e.y-n.y);return n.x=n.y=0,r.clip(n)
,r},get_window_coordinates:function(e,t){var n=this.get_canvas_bounds(t),r=new M.assignfeedback_editpdf.point(e.x+n.x,e.y+n.y);return r},link_handler:function(t){var n;t.preventDefault(),this.dialogue?this.dialogue.show():(this.dialogue=new M.core.dialogue({headerContent:this.get("header"),bodyContent:this.get("body"),footerContent:this.get("footer"),width:"840px",visible:!0}),this.dialogue.centerDialogue(),this.dialogue.get("boundingBox").addClass(r.DIALOGUE),this.loadingicon=e.one(s.LOADINGICON),n=e.one(s.DRAWINGCANVAS),this.graphic=new e.Graphic({render:s.DRAWINGCANVAS}),n.on("gesturemovestart",this.edit_start,null,this),n.on("gesturemove",this.edit_move,null,this),n.on("gesturemoveend",this.edit_end,null,this),this.refresh_button_state()),this.load_all_pages()},delete_link_handler:function(t){var r,i;t.preventDefault();var s=n,o;o={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"deletefeedbackdocument",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(){r=e.one("#"+this.get("downloadlinkid")),i=e.one("#"+this.get("deletelinkid")),r.addClass("hidden"),i.addClass("hidden")},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(s,o)},load_all_pages:function(){var t=n,r;r={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"loadallpages",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(e,t){this.all_pages_loaded(t.responseText)},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(t,r)},all_pages_loaded:function(t){var n,r,i,s;try{n=e.JSON.parse(t)}catch(o){return this.dialogue.hide(),new M.core.exception(o)}this.pagecount=n.pagecount,this.pages=n.pages;for(r=0;r<this.pages.length;r++){for(i=0;i<this.pages[r].comments.length;i++)s=this.pages[r].comments[i],this.pages[r].comments[i]=new M.assignfeedback_editpdf.comment(this,s.gradeid,s.pageno,s.x,s.y,s.width,s.colour,s.rawtext);for(i=0;i<this.pages[r].annotations.length;i++)annotation=this.pages[r].annotations[i],this.pages[r].annotations[i]=new M.assignfeedback_editpdf.annotation(this,annotation.gradeid,annotation.pageno,annotation.x,annotation.y,annotation.endx,annotation.endy,annotation.type,annotation.colour,annotation.path)}this.quicklist.load(),this.setup_navigation(),this.setup_toolbar(),this.change_page(),this.setup_save_cancel()},setup_stamp_picker:function(t,n,r){var i=e.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),s,o,u,a;e.each(n,function(t,n){var r,s;r=e.Node.create("<button/>"),r.setAttribute("title",M.util.get_string("stamp","assignfeedback_editpdf",n)),r.setAttribute("stampindex",n),r.setStyle("backgroundImage","url('"+t.url+"')"),r.setStyle("backgroundSize","100% 100%"),r.setStyle("backgroundRepeat","no-repeat"),r.setStyle("height","30px"),r.setStyle("width","40px"),r.setStyle("borderStyle","solid"),s=e.Node.create("<li/>"),s.append(r),i.append(s)},this),o=e.Node.create("<div/>"),i.delegate("click",r,"button",this),i.delegate("key",r,"down:13","button",this),u=e.Node.create("<h3/>"),u.addClass("accesshide"),u.setHTML(M.util.get_string("stamppicker","assignfeedback_editpdf")),o.append(u),o.append(i),s=new M.core.dialogue({extraClasses:["assignfeedback_editpdf_colourpicker"],draggable:!1,centered:!1,width:"auto",lightbox:!1,visible:!1,bodyContent:o,footerContent:"",align:{node:t,points:[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]}}),o.on("clickoutside",function(e){e.target!==t&&e.target.ancestor()!==t&&(e.preventDefault(),s.hide())}),a=function(){this.currentstamppicker=s,s.show()},t.on("click",a,this),t.on("key",a,"down:13",this)},setup_toolbar:function(){var t,n,r,i,o,u,l,h;e.each(c,function(n,r){t=e.one(n),t.on("click",this.handle_toolbutton,this,r),t.on("key",this.handle_toolbutton,"down:13",this,r),t.setAttribute("aria-pressed","false")},this),i=e.one(s.SEARCHCOMMENTSBUTTON),i.on("click",this.open_search_comments,this),i.on("key",this.open_search_comments,"down:13",this),n=e.one(s.COMMENTCOLOURBUTTON),h=new M.assignfeedback_editpdf.colourpicker({buttonNode:n,colours:a,callback:function(e){var t=e.target.getAttribute("data-colour");t||(t=e.target.ancestor().getAttribute("data-colour")),this.currentedit.commentcolour=t,this.refresh_button_state()},context:this}),r=e.one(s.ANNOTATIONCOLOURBUTTON),h=new M.assignfeedback_editpdf.colourpicker({buttonNode:r,colours:f,callback:function(e){var t=e.target.getAttribute("data-colour");t||(t=e.target.ancestor().getAttribute("data-colour")),this.currentedit.annotationcolour=t,this.refresh_button_state()},context:this}),u=this.get("stampfileurls"),l=function(){this.rootcontext.stamps[this.stampindex].height=this.height,this.rootcontext.stamps[this.stampindex].width=this.width};for(o=0;o<u.length;o++){var p=new Stamp;p.url=M.cfg.wwwroot+stampfileurl,this.stamps[o]=p;var d=new Image;d.src=M.cfg.wwwroot+stampfileurl,d.stampindex=o,d.rootcontext=this,d.onload=l}stampsbutton=e.one(s.STAMPSBUTTON),u.length<=0?stampsbutton.setAttribute("disabled","true"):(this.currentstamp=0,stampsbutton.setStyle("backgroundImage","url('"+this.stamps[this.currentstamp].url+"')"),stampsbutton.setStyle("backgroundSize","100% 100%"),stampsbutton.setStyle("backgroundRepeat","no-repeat"),this.setup_stamp_picker(stampsbutton,this.stamps,function(t){this.currentstamp=t.target.getAttribute("stampindex"),button=e.one(s.STAMPSBUTTON),button.setStyle("backgroundImage","url('"+this.stamps[this.currentstamp].url+"')"),button.setStyle("backgroundSize","100% 100%"),button.setStyle("backgroundRepeat","no-repeat"),this.currentstamppicker.hide()}))},handle_toolbutton:function(t,n){var r;t.preventDefault(),r=e.one(c[this.currentedit.tool]),r.removeClass("assignfeedback_editpdf_selectedbutton"),r.setAttribute("aria-pressed","false"),this.currentedit.tool=n,this.refresh_button_state()},setup_save_cancel:function(){var t;t=e.one(s.SAVE),t.on("mousedown",this.handle_save,this),
t.on("key",this.handle_save,"down:13",this),t.removeAttribute("disabled")},handle_cancel:function(e){e.preventDefault(),this.dialogue.hide()},stringify_current_page:function(){var t=[],n=[],r,i=0;for(i=0;i<this.pages[this.currentpage].comments.length;i++)t[i]=this.pages[this.currentpage].comments[i].clean();for(i=0;i<this.pages[this.currentpage].annotations.length;i++)n[i]=this.pages[this.currentpage].annotations[i].clean();return r={comments:t,annotations:n},e.JSON.stringify(r)},handle_save:function(t){t.preventDefault();var r=n,i;i={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"generatepdf",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(t,n){var r,i,s,o;try{r=e.JSON.parse(n.responseText);if(r.error)return new M.core.ajaxException(r);r.url&&(i=e.one("#"+this.get("downloadlinkid")),o=e.one("#"+this.get("downloadlinkid")+" span"),s=e.one("#"+this.get("deletelinkid")),o.setHTML(r.filename),i.setAttribute("href",r.url),i.removeClass("hidden"),s.removeClass("hidden")),this.dialogue.hide()}catch(u){return new M.core.exception(u)}},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(r,i)},edit_start:function(t){var n=e.one(s.DRAWINGCANVAS).getXY(),r=document.body.scrollTop,i=document.body.scrollLeft,o={x:t.clientX-n[0]+i,y:t.clientY-n[1]+r};if(this.currentedit.starttime)return;this.currentedit.starttime=(new Date).getTime(),this.currentedit.start=o,this.currentedit.end={x:o.x,y:o.y},this.currentannotation&&(this.currentedit.annotationstart={x:this.currentannotation.x,y:this.currentannotation.y}),this.currentedit.tool==="stamp"&&this.redraw_current_edit()},get_current_drawable:function(){var t=new M.assignfeedback_editpdf.drawable(this),n,r,i,s,o,u,l;if(!this.currentedit.start||!this.currentedit.end)return!1;this.currentedit.tool==="pen"&&(n=this.graphic.addShape({type:e.Path,fill:!1,stroke:{weight:h,color:f[this.currentedit.annotationcolour]}}),l=!0,e.each(this.currentedit.path,function(e){l?(n.moveTo(e.x,e.y),l=!1):n.lineTo(e.x,e.y)},this),n.end()),s=this.currentedit.start.x,this.currentedit.end.x>s?r=this.currentedit.end.x-s:(s=this.currentedit.end.x,r=this.currentedit.start.x-s),o=this.currentedit.start.y,this.currentedit.end.y>o?i=this.currentedit.end.y-o:(o=this.currentedit.end.y,i=this.currentedit.start.y-o);if(this.currentedit.tool==="stamp")return this.currentstampnodeid=Math.random()*1e16+1,stampnode=e.Node.create('<div id="'+this.currentstampnodeid+'" class="stamp" style="background-image:url(\''+this.stamps[this.currentstamp].url+"')\"/>"),e.one(".drawingcanvas").append(stampnode),stampnode.setStyles({position:"absolute",left:this.currentedit.end.x,top:this.currentedit.end.y,height:this.stamps[this.currentstamp].height,width:this.stamps[this.currentstamp].width}),t.nodes.push(stampnode),t;this.currentedit.tool==="comment"&&(n=this.graphic.addShape({type:e.Rect,width:r,height:i,fill:{color:a[this.currentedit.commentcolour]},x:s,y:o})),this.currentedit.tool==="line"&&(n=this.graphic.addShape({type:e.Path,fill:!1,stroke:{weight:h,color:f[this.currentedit.annotationcolour]}}),n.moveTo(this.currentedit.start.x,this.currentedit.start.y),n.lineTo(this.currentedit.end.x,this.currentedit.end.y),n.end());if(this.currentedit.tool==="rectangle"||this.currentedit.tool==="oval")this.currentedit.tool==="rectangle"&&(tooltype=e.Rect),this.currentedit.tool==="oval"&&(tooltype=e.Ellipse),n=this.graphic.addShape({type:tooltype,width:r,height:i,stroke:{weight:h,color:f[this.currentedit.annotationcolour]},x:s,y:o});return this.currentedit.tool==="highlight"&&(u=f[this.currentedit.annotationcolour],u=u.replace("rgb","rgba"),u=u.replace(")",",0.5)"),n=this.graphic.addShape({type:e.Rect,width:r,height:16,stroke:!1,fill:{color:u},x:s,y:this.currentedit.start.y})),t.shapes.push(n),t},redraw_current_edit:function(){this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=this.get_current_drawable()},move_annotation:function(t,n,r){var i=n-t.x,s=r-t.y,o,u,a;t.x+=i,t.y+=s,t.endx+=i,t.endy+=s,t.path&&(o=[],u=t.path.split(":"),e.each(u,function(e){a=e.split(","),o.push(parseInt(a[0],10)+i+","+(parseInt(a[1],10)+s))}),t.path=o.join(":")),t.drawable.erase(),this.drawables.push(t.draw())},edit_move:function(t){var n=e.one(s.DRAWINGCANVAS),r=parseInt(n.getStyle("width"),10),i=parseInt(n.getStyle("height"),10),o=n.getXY(),u=document.body.scrollTop,a=document.body.scrollLeft,f={x:t.clientX-o[0]+a,y:t.clientY-o[1]+u};if(f.x<0||f.x>r||f.y<0||f.y>i)return;this.currentedit.tool==="pen"&&this.currentedit.path.push(f),this.currentedit.tool==="select"?this.currentannotation&&this.currentedit&&this.currentannotation.move(this.currentedit.annotationstart.x+f.x-this.currentedit.start.x,this.currentedit.annotationstart.y+f.y-this.currentedit.start.y):this.currentedit.start&&(this.currentedit.end=f,this.redraw_current_edit())},edit_end:function(){var t,n,r,i,s,o,u,a=!1;o=(new Date).getTime()-this.currentedit.start;if(o<l||this.currentedit.start===!1)return;if(this.currentedit.tool==="comment")i=this.currentedit.start.x,this.currentedit.end.x>i?n=this.currentedit.end.x-i:(i=this.currentedit.end.x,n=this.currentedit.start.x-i),s=this.currentedit.start.y,this.currentedit.end.y>s?r=this.currentedit.end.y-s:(s=this.currentedit.end.y,r=this.currentedit.start.y-s),n<100&&(n=100),t=new M.assignfeedback_editpdf.comment(this,this.get("gradeid"),this.currentpage,i,s,n,this.currentedit.commentcolour,""),this.pages[this.currentpage].comments.push(t),this.drawables.push(t.draw(!0));else if(this.currentedit.tool==="pen"){u="";var f=null,c=null,h=null,p=null;e.each(this.currentedit.path,function(e){u=u+e.x+","+e.y+":",f===null?(f=h=e.x,c=p=e.y):(e.x<f&&(f=e.x),e.y<c&&(c=e.y),e.x>h&&(h=e.x),e.y>p&&(p=e.y))},this),u=u.substring(0,u.length-1),t=new M.assignfeedback_editpdf.annotation(this,this.get("gradeid"),this.currentpage,f,c,h,p,this.currentedit.tool,this.currentedit.annotationcolour,u),this.pages[this.currentpage
].annotations.push(t),this.drawables.push(t.draw()),this.currentedit.path=[]}else this.currentedit.tool==="highlight"?(i=this.currentedit.start.x,this.currentedit.end.x>i?n=this.currentedit.end.x-i:(i=this.currentedit.end.x,n=this.currentedit.start.x-i),s=this.currentedit.start.y,r=16,t=new M.assignfeedback_editpdf.annotation(this,this.get("gradeid"),this.currentpage,this.currentedit.start.x,this.currentedit.start.y,this.currentedit.end.x,this.currentedit.end.y,this.currentedit.tool,this.currentedit.annotationcolour,""),this.pages[this.currentpage].annotations.push(t),this.drawables.push(t.draw())):this.currentedit.tool==="select"?(i=this.currentedit.end.x,s=this.currentedit.end.y,annotations=this.pages[this.currentpage].annotations,e.each(annotations,function(e){(i-e.x)*(i-e.endx)<=0&&(s-e.y)*(s-e.endy)<=0&&(a=e)}),a&&(this.currentannotation=a),this.redraw()):(t=new M.assignfeedback_editpdf.annotation(this,this.get("gradeid"),this.currentpage,this.currentedit.start.x,this.currentedit.start.y,this.currentedit.end.x,this.currentedit.end.y,this.currentedit.tool,this.currentedit.annotationcolour,""),this.pages[this.currentpage].annotations.push(t),this.drawables.push(t.draw()));this.save_current_page(),this.currentedit.starttime=0,this.currentedit.start=!1,this.currentedit.end=!1,this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=!1},save_current_page:function(){var t=n,r;r={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"savepage",index:this.currentpage,userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),page:this.stringify_current_page()},on:{success:function(t,n){var r;try{r=e.JSON.parse(n.responseText);if(r.error)return new M.core.ajaxException(r)}catch(i){return new M.core.exception(i)}},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(t,r)},filter_search_comments:function(){var t,n,r;t=e.one(s.SEARCHFILTER),n=e.one(s.SEARCHCOMMENTSLIST),r=t.get("value"),n.all("li").each(function(e){e.get("text").indexOf(r)!==-1?e.show():e.hide()})},focus_on_comment:function(e){var t=e.target.ancestor("li"),n=t.getData("comment");this.searchcommentswindow.hide(),n.pageno===this.currentpage?n.drawable.nodes[0].one("textarea").focus():(this.currentpage=n.pageno,this.change_page(),n.drawable.nodes[0].one("textarea").focus())},open_search_comments:function(t){var n,r,i,s;this.searchcommentswindow?(n=this.searchcommentswindow.get("boundingBox").one("ul"),n.all("li").remove(!0)):(i=e.Node.create("<div/>"),s=M.util.get_string("filter","assignfeedback_editpdf"),r=e.Node.create('<input type="text" size="20" placeholder="'+s+'"/>'),i.append(r),n=e.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),i.append(n),this.searchcommentswindow=new M.core.dialogue({extraClasses:["assignfeedback_editpdf_searchcomments"],draggable:!1,centered:!0,lightbox:!0,width:"400px",visible:!1,zIndex:100,headerContent:M.util.get_string("searchcomments","assignfeedback_editpdf"),bodyContent:i,footerContent:""}),r.on("keyup",this.filter_search_comments,null,this),n.delegate("click",this.focus_on_comment,"a",this),n.delegate("key",this.focus_on_comment,"enter,space","a",this)),e.each(this.pages,function(t){e.each(t.comments,function(t){var r=e.Node.create('<li><a href="#" tabindex="-1"><pre>'+t.rawtext+"</pre></a></li>");n.append(r),r.setData("comment",t)},this)},this),this.searchcommentswindow.centerDialogue(),this.searchcommentswindow.show(),t.preventDefault()},redraw:function(){var e,t;t=this.pages[this.currentpage];while(this.drawables.length>0)this.drawables.pop().erase();for(e=0;e<t.annotations.length;e++)this.drawables.push(t.annotations[e].draw());for(e=0;e<t.comments.length;e++)this.drawables.push(t.comments[e].draw(!1))},change_page:function(){var t=e.one(s.DRAWINGCANVAS),n,r,i;r=e.one(s.PREVIOUSBUTTON),i=e.one(s.NEXTBUTTON),this.currentpage>0?r.removeAttribute("disabled"):r.setAttribute("disabled","true"),this.currentpage<this.pagecount-1?i.removeAttribute("disabled"):i.setAttribute("disabled","true"),n=this.pages[this.currentpage],this.loadingicon.hide(),t.setStyle("backgroundImage",'url("'+n.url+'")'),this.redraw()},setup_navigation:function(){var t,n,r,i,o;t=e.one(s.PAGESELECT),options=t.all("option");if(options.size()<=1)for(n=0;n<this.pages.length;n++)r=e.Node.create("<option/>"),r.setAttribute("value",n),r.setHTML(n+1),t.append(r);t.removeAttribute("disabled"),t.on("change",function(){this.currentpage=t.get("value"),this.change_page()},this),i=e.one(s.PREVIOUSBUTTON),o=e.one(s.NEXTBUTTON),i.on("click",this.previous_page,this),i.on("key",this.previous_page,"down:13",this),o.on("click",this.next_page,this),o.on("key",this.next_page,"down:13",this)},previous_page:function(){this.currentpage--,this.currentpage<0&&(this.currentpage=0),this.change_page()},next_page:function(){this.currentpage++,this.currentpage>=this.pages.length&&(this.currentpage=this.pages.length-1),this.change_page()}},e.extend(EDITOR,e.Base,EDITOR.prototype,{NAME:"moodle-assignfeedback_editpdf-editor",ATTRS:{userid:{validator:e.Lang.isInteger,value:0},assignmentid:{validator:e.Lang.isInteger,value:0},attemptnumber:{validator:e.Lang.isInteger,value:0},header:{validator:e.Lang.isString,value:""},body:{validator:e.Lang.isString,value:""},footer:{validator:e.Lang.isString,value:""},linkid:{validator:e.Lang.isString,value:""},deletelinkid:{validator:e.Lang.isString,value:""},downloadlinkid:{validator:e.Lang.isString,value:""},menuicon:{validator:e.Lang.isString,value:""},stampfileurls:{validator:e.Lang.isArray,value:""}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.editor=M.assignfeedback_editpdf.editor||{},M.assignfeedback_editpdf.editor.init=M.assignfeedback_editpdf.editor.init||function(e){return new EDITOR(e)}},"@VERSION@",{requires:["base","event","node","io","graphics","json","event-move","querystring-stringify-simple","moodle-core-notification-dialog","moodle-core-notification-exception"
,"moodle-core-notification-ajaxexception"]});
