define(["jquery","core/ajax","core/log","core/str","core/notification","mod_book/jquerypp.custom","mod_book/modernizr.custom","mod_book/jquery.bookblock"],function(a,b,c,d,e){return{initialise:function(c,d){var e,f,g=a("#bb-bookblock"),h=a("div.book-section"),i=!1,j=g.css("min-height"),k=j,l=j,m=function(){clearTimeout(f),setTimeout(function(){g.height(j),l=g[0].scrollHeight,g.height(k),g.animate({height:l},100)},500)},n=function(b){e=a("ul.toc li"),e.removeClass("active");var c=a(".book-nav ul.toc li");return c.length==b+1&&h.addClass("bb-end"),0>b?void h.addClass("bb-start"):(c.eq(b).addClass("active"),void o())},o=function(){var b=a(".book-nav ul.toc li.active"),c=a(".book-nav .dropdown.open .dropdown-menu ul");if(void 0!==b.position()){var d=c.scrollTop(),e=d+c.height(),f=b.position().top;b&&(0>f||d+f>e)&&c.animate({scrollTop:d-10+f},100)}},p=function(){var b=a(".page-progress-top .current-page"),c=a(".bb-item:visible .page-progress-bottom").html();if(c)b.html(c);else{var d=a('.book_content[data-chapterid="false"] .total').text();b.html('Page <span class="current">0</span> of <span class="total">'+d+"</span>")}var e=a(".page-progress-top .progress-bar"),f=b.find(".current").text(),g=b.find(".total").text(),h=Math.round(parseInt(f)/parseInt(g)*100);!h||0>=h?e.width(0):e.width(h+"%")},q=function(a){a.find("iframe").each(function(){try{if(-1==this.src.indexOf("youtube.com/embed")||-1==this.src.indexOf("enablejsapi=1"))throw"Exception";var a=JSON.stringify({event:"command",func:"pauseVideo",args:[]});this.contentWindow.postMessage(a,"*")}catch(b){this.src=this.src}})};g.bookblock({startPage:c+1,speed:d,onEndFlip:function(c,d,e,f,m){if(n(d-1),q(g.find(".bb-item").eq(c)),f?h.addClass("bb-start"):h.removeClass("bb-start"),m?h.addClass("bb-end"):h.removeClass("bb-end"),g.height(j),l=g[0].scrollHeight,g.height(k),(k>l||a(window).scrollTop()>l)&&a("html, body").animate({scrollTop:a("div[role=main]").offset().top-15},300),r(a(".book-nav ul.toc")),p(),g.animate({height:l},100),k=l,i)i=!1;else{var o=g.data("bookid"),s=g.find(".bb-item").eq(d),t=s.data("chapterid");document.title=s.data("chaptertitle"),b.call([{methodname:"mod_book_view_book",args:{bookid:o,chapterid:t},done:function(a){}}]);var u="";t&&(u="&chapterid="+t);var v=window.location.href.replace(/\&chapterid[\=a-z0-9]*/i,""),w=v.split("#")[1];w=void 0!==w?"#"+w:"";var x=v.split("#")[0]+u+w;window.history.pushState({page:d},"",x)}},onLoaded:function(){g.height(g[0].scrollHeight),p()}}),a(window).on("popstate",function(a){i=!0,a.originalEvent.state?g.bookblock("jump",a.originalEvent.state.page+1):g.bookblock("jump",c)}),a(window).on("resize",m),a("#region-main .toggle").on("click",m),g.on("swipeleft",function(){return a(this).bookblock("next"),!1}).on("swiperight",function(){return a(this).bookblock("prev"),!1}),a(".book-nav").on("click touchstart",".bb-btn",function(a){var b=a.currentTarget;switch(a.preventDefault(),b.id){case"bb-nav-next":g.bookblock("next"),a.stopPropagation();break;case"bb-nav-prev":g.bookblock("prev"),a.stopPropagation();break;case"bb-nav-first":g.bookblock("first");break;case"bb-nav-last":g.bookblock("last")}}),e=a("ul.toc li > a"),e.on("click touchstart",function(b){b.preventDefault();var c=a(this).parents("ul.toc").find("li > a").index(a(this));return g.bookblock("jump",c+2),!1}),a(".book-nav ul.toc").on("scroll",function(){r(a(this))});var r=function(a){var b=void 0===a[0].scrollHeight;b||a.scrollTop()+a.innerHeight()>=a[0].scrollHeight?a.addClass("scroll-limit-bottom"):a.removeClass("scroll-limit-bottom"),b||a.scrollTop()<6?a.addClass("scroll-limit-top"):a.removeClass("scroll-limit-top")};a(".book-nav .dropdown").on("shown.bs.dropdown",function(){r(a(".book-nav ul.toc")),o()}),n(c-1)}}});